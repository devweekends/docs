<svg width="1080" height="1080" viewBox="0 0 1080 1080" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="1080" height="1080" fill="#18181B"/>

  <text x="60" y="80" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#FAFAFA" letter-spacing="3">DEV WEEKENDS</text>

  <rect x="60" y="140" width="240" height="40" fill="#F97316"/>
  <text x="180" y="168" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#FAFAFA" text-anchor="middle" letter-spacing="2">LINUX INTERNALS</text>

  <text x="60" y="280" font-family="system-ui, sans-serif" font-size="46" font-weight="700" fill="#FAFAFA">Packet</text>
  <text x="60" y="340" font-family="system-ui, sans-serif" font-size="46" font-weight="700" fill="#F97316">Receive Path</text>

  <text x="60" y="400" font-family="system-ui, sans-serif" font-size="18" fill="#A1A1AA">From NIC to application socket</text>

  <!-- Main diagram area -->
  <rect x="60" y="440" width="960" height="520" fill="#27272A" rx="8"/>

  <!-- Hardware -->
  <rect x="100" y="470" width="880" height="70" fill="#7F1D1D" rx="8"/>
  <text x="150" y="495" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#FCA5A5">1. Hardware (NIC)</text>
  <rect x="150" y="505" width="800" height="25" fill="#991B1B" rx="4"/>
  <text x="550" y="523" font-family="system-ui, sans-serif" font-size="10" fill="#FCA5A5" text-anchor="middle">Packet arrives → DMA to ring buffer → Raise hardware IRQ</text>

  <path d="M 540 540 L 540 560" stroke="#F97316" stroke-width="3" marker-end="url(#arrowNet1)"/>
  <defs>
    <marker id="arrowNet1" markerWidth="10" markerHeight="7" refX="5" refY="7" orient="auto">
      <polygon points="0 0, 10 0, 5 7" fill="#F97316"/>
    </marker>
  </defs>

  <!-- Driver Hard IRQ -->
  <rect x="100" y="560" width="880" height="70" fill="#7C3AED" rx="8"/>
  <text x="150" y="585" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#E9D5FF">2. Driver (Hard IRQ)</text>
  <rect x="150" y="595" width="800" height="25" fill="#6D28D9" rx="4"/>
  <text x="550" y="613" font-family="system-ui, sans-serif" font-size="10" fill="#E9D5FF" text-anchor="middle">Acknowledge IRQ → Schedule NAPI poll → Disable NIC interrupts for this queue</text>

  <path d="M 540 630 L 540 650" stroke="#F97316" stroke-width="3" marker-end="url(#arrowNet2)"/>
  <defs>
    <marker id="arrowNet2" markerWidth="10" markerHeight="7" refX="5" refY="7" orient="auto">
      <polygon points="0 0, 10 0, 5 7" fill="#F97316"/>
    </marker>
  </defs>

  <!-- NAPI Poll -->
  <rect x="100" y="650" width="880" height="85" fill="#1E40AF" rx="8"/>
  <text x="150" y="675" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#93C5FD">3. NAPI Poll (Soft IRQ)</text>
  <rect x="150" y="685" width="800" height="40" fill="#1E3A8A" rx="4"/>
  <circle cx="170" cy="700" r="2" fill="#93C5FD"/>
  <text x="180" y="703" font-family="system-ui, sans-serif" font-size="9" fill="#BFDBFE">Allocate sk_buff (socket buffer) for packet</text>
  <circle cx="170" cy="715" r="2" fill="#93C5FD"/>
  <text x="180" y="718" font-family="system-ui, sans-serif" font-size="9" fill="#BFDBFE">Copy packet data from ring buffer → Set metadata (protocol, device, len)</text>

  <path d="M 540 735 L 540 755" stroke="#F97316" stroke-width="3" marker-end="url(#arrowNet3)"/>
  <defs>
    <marker id="arrowNet3" markerWidth="10" markerHeight="7" refX="5" refY="7" orient="auto">
      <polygon points="0 0, 10 0, 5 7" fill="#F97316"/>
    </marker>
  </defs>

  <!-- Network Stack -->
  <rect x="100" y="755" width="880" height="105" fill="#166534" rx="8"/>
  <text x="150" y="780" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#BBF7D0">4. Network Stack Processing</text>

  <rect x="150" y="790" width="380" height="60" fill="#14532D" rx="4"/>
  <text x="340" y="810" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#BBF7D0" text-anchor="middle">Link Layer (L2)</text>
  <circle cx="170" cy="825" r="2" fill="#22C55E"/>
  <text x="180" y="828" font-family="system-ui, sans-serif" font-size="9" fill="#BBF7D0">Remove Ethernet header</text>
  <circle cx="170" cy="840" r="2" fill="#22C55E"/>
  <text x="180" y="843" font-family="system-ui, sans-serif" font-size="9" fill="#BBF7D0">Determine next protocol (IP)</text>

  <rect x="550" y="790" width="400" height="60" fill="#14532D" rx="4"/>
  <text x="750" y="810" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#BBF7D0" text-anchor="middle">Network Layer (L3 - IP)</text>
  <circle cx="570" cy="825" r="2" fill="#22C55E"/>
  <text x="580" y="828" font-family="system-ui, sans-serif" font-size="9" fill="#BBF7D0">Routing decision, Netfilter hooks</text>
  <circle cx="570" cy="840" r="2" fill="#22C55E"/>
  <text x="580" y="843" font-family="system-ui, sans-serif" font-size="9" fill="#BBF7D0">Remove IP header → Pass to TCP/UDP</text>

  <path d="M 540 860 L 540 880" stroke="#F97316" stroke-width="3" marker-end="url(#arrowNet4)"/>
  <defs>
    <marker id="arrowNet4" markerWidth="10" markerHeight="7" refX="5" refY="7" orient="auto">
      <polygon points="0 0, 10 0, 5 7" fill="#F97316"/>
    </marker>
  </defs>

  <!-- Transport Layer -->
  <rect x="100" y="880" width="880" height="70" fill="#9A3412" rx="8"/>
  <text x="150" y="905" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#FED7AA">5. Transport Layer (L4 - TCP/UDP)</text>
  <rect x="150" y="915" width="800" height="25" fill="#7C2D12" rx="4"/>
  <text x="550" y="933" font-family="system-ui, sans-serif" font-size="10" fill="#FED7AA" text-anchor="middle">Lookup socket by port → Add to socket receive queue → Wake up application</text>

  <path d="M 540 950 L 540 975" stroke="#F97316" stroke-width="3" marker-end="url(#arrowNet5)"/>
  <defs>
    <marker id="arrowNet5" markerWidth="10" markerHeight="7" refX="5" refY="7" orient="auto">
      <polygon points="0 0, 10 0, 5 7" fill="#F97316"/>
    </marker>
  </defs>

  <!-- Application -->
  <rect x="100" y="975" width="880" height="60" fill="#22C55E" rx="8"/>
  <text x="150" y="1000" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#052E16">6. Application (User Space)</text>
  <rect x="150" y="1010" width="800" height="15" fill="#14532D" rx="3"/>
  <text x="550" y="1022" font-family="monospace" font-size="9" fill="#BBF7D0" text-anchor="middle">read() / recv() syscall → Copy data to user buffer</text>

  <!-- Key insight -->
  <rect x="60" y="1045" width="960" height="65" fill="#27272A" rx="8"/>
  <text x="540" y="1070" font-family="system-ui, sans-serif" font-size="14" fill="#A1A1AA" text-anchor="middle">NAPI (New API) batches packet processing to reduce interrupt overhead — <tspan fill="#F97316">crucial for high packet rates</tspan></text>
  <text x="540" y="1090" font-family="system-ui, sans-serif" font-size="12" fill="#71717A" text-anchor="middle">XDP (eXpress Data Path) allows processing at driver level for ultra-low latency (bypasses most kernel stack)</text>

  <text x="540" y="1148" font-family="system-ui, sans-serif" font-size="14" fill="#52525B" text-anchor="middle">@devweekends</text>
</svg>
