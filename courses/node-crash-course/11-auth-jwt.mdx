---
title: "11. Authentication with JWT"
description: "Implement secure authentication using JSON Web Tokens (JWT) and bcrypt."
---

# Authentication with JWT

Authentication is the process of verifying the identity of a user. In modern web applications, **JSON Web Tokens (JWT)** are a popular standard for stateless authentication.

## Prerequisites

Install the necessary packages:

```bash
npm install jsonwebtoken bcryptjs
```

- **jsonwebtoken**: To sign and verify tokens.
- **bcryptjs**: To hash passwords securely.

## 1. User Registration (Hashing Passwords)

Never store passwords in plain text. Use `bcryptjs` to hash them.

```javascript
const bcrypt = require('bcryptjs');

// ... inside your register route
const { username, password } = req.body;

// Check if user exists...

// Hash password
const salt = await bcrypt.genSalt(10);
const hashedPassword = await bcrypt.hash(password, salt);

// Save user with hashedPassword...
```

## 2. User Login (Comparing Passwords)

When a user logs in, compare the provided password with the hashed password in the database.

```javascript
const validPassword = await bcrypt.compare(password, user.password);

if (!validPassword) {
  return res.status(400).json({ msg: 'Invalid credentials' });
}
```

## 3. Generating a JWT

If the password is valid, generate a token and send it to the client.

```javascript
const jwt = require('jsonwebtoken');

const payload = {
  user: {
    id: user.id
  }
};

jwt.sign(
  payload,
  process.env.JWT_SECRET,
  { expiresIn: '1h' },
  (err, token) => {
    if (err) throw err;
    res.json({ token });
  }
);
```

**Note**: Store `JWT_SECRET` in your `.env` file.

## 4. Protecting Routes (Middleware)

Create middleware to verify the token on protected routes.

**middleware/auth.js**
```javascript
const jwt = require('jsonwebtoken');

module.exports = function(req, res, next) {
  // Get token from header
  const token = req.header('x-auth-token');

  // Check if not token
  if (!token) {
    return res.status(401).json({ msg: 'No token, authorization denied' });
  }

  // Verify token
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded.user;
    next();
  } catch (err) {
    res.status(401).json({ msg: 'Token is not valid' });
  }
};
```

## 5. Using the Middleware

```javascript
const auth = require('./middleware/auth');

// Protected route
app.get('/api/auth/user', auth, async (req, res) => {
  try {
    // Fetch user from DB using req.user.id
    // ...
    res.json(user);
  } catch (err) {
    res.status(500).send('Server Error');
  }
});
```

## Summary

- **bcryptjs**: Use `hash()` to encrypt passwords and `compare()` to validate them.
- **JWT**: Use `sign()` to create a token and `verify()` to check it.
- **Middleware**: Create a custom middleware to protect private routes.
- **Stateless**: The server doesn't store session data; the token contains all necessary info.

**Next Step**: See **React Chapter 11** to learn how to consume this auth API on the frontend.
