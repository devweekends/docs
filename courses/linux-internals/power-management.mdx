---
title: "Power & Thermal Management"
sidebarTitle: "Power Management"
description: "Master Linux power management: cpufreq, cpuidle, thermal zones, and power optimization for cloud infrastructure"
icon: "bolt"
---

<Frame>
  <img src="/images/courses/linux-internals/power-management-concept.svg" alt="Linux Power Management - CPU frequency, idle states, and thermal control" />
</Frame>

# Power & Thermal Management

Understanding power management is essential for infrastructure engineers. Whether optimizing cloud costs, managing thermal throttling, or debugging performance issues, these concepts matter at scale.

<Info>
**Interview Frequency**: Medium (important for infrastructure/performance roles)  
**Key Topics**: cpufreq, cpuidle, thermal throttling, power governors  
**Time to Master**: 6-8 hours
</Info>

---

## Why Power Management Matters

In the cloud era, power management directly impacts:
- **Cost**: Power = money (cloud providers charge for compute)
- **Performance**: Thermal throttling degrades performance
- **Reliability**: Heat shortens hardware lifespan
- **Capacity planning**: Power and cooling constraints limit density

---

## Power Management Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LINUX POWER MANAGEMENT STACK                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User Space                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  Tools: turbostat, cpupower, thermald, tuned                            ││
│  │  Interfaces: /sys/devices/system/cpu/, /sys/class/thermal/              ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  Kernel Frameworks                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    ││
│  │  │  cpufreq    │  │  cpuidle    │  │  thermal    │  │  PM QoS     │    ││
│  │  │ (frequency) │  │  (C-states) │  │  (cooling)  │  │  (latency)  │    ││
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    ││
│  │         │                │                │                │            ││
│  │         └────────────────┼────────────────┼────────────────┘            ││
│  │                          │                │                              ││
│  │                          ▼                ▼                              ││
│  │         ┌────────────────────────────────────────────────┐              ││
│  │         │           Power Management Core                 │              ││
│  │         │  - ACPI interface                               │              ││
│  │         │  - Intel/AMD specific drivers                   │              ││
│  │         │  - Device PM                                    │              ││
│  │         └────────────────────────────────────────────────┘              ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  Hardware                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  CPU: P-states (frequency), C-states (idle), Turbo Boost               ││
│  │  Sensors: Temperature, power consumption, voltage                       ││
│  │  Cooling: Fans, passive cooling                                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## CPU Frequency Scaling (cpufreq)

### P-States: Performance States

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CPU P-STATES (Performance States)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  P-State    Frequency      Voltage       Power          Use Case            │
│  ────────────────────────────────────────────────────────────────────────   │
│  P0         3.6 GHz       1.2 V         ~100W          Max performance      │
│  P1         3.2 GHz       1.1 V         ~75W           High performance     │
│  P2         2.8 GHz       1.0 V         ~50W           Normal use           │
│  P3         2.4 GHz       0.9 V         ~35W           Power saving         │
│  P4         2.0 GHz       0.85V         ~25W           Low power            │
│  ...        ...           ...           ...            ...                   │
│  Pn         800 MHz       0.7 V         ~5W            Minimum              │
│                                                                              │
│  Turbo Boost (above base frequency):                                         │
│  • Single-core turbo: Up to 4.8 GHz                                         │
│  • All-core turbo: Up to 4.2 GHz                                            │
│  • Depends on: Temperature, power budget, active cores                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Viewing Frequency Information

```bash
# View available frequencies
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies
# 800000 1000000 1200000 1400000 1600000 1800000 2000000 2200000 2400000

# Current frequency
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
# 2400000 (2.4 GHz)

# Hardware limits
cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_min_freq  # 800000
cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq  # 3600000

# Current governor
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
# schedutil

# Using cpupower tool
cpupower frequency-info
cpupower frequency-set -g performance  # Set governor

# Real-time monitoring with turbostat
sudo turbostat --interval 1
```

### Frequency Governors

| Governor | Description | Use Case |
|----------|-------------|----------|
| `performance` | Always max frequency | Latency-sensitive, benchmarks |
| `powersave` | Always min frequency | Battery saving, idle servers |
| `ondemand` | Scale with CPU load | General purpose (legacy) |
| `conservative` | Scale gradually | Smooth frequency transitions |
| `schedutil` | Scheduler-integrated | Modern default, best for most |
| `userspace` | Manual control | Custom tuning |

### Setting Frequency

```bash
# Set governor for all CPUs
for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
    echo performance > $cpu/cpufreq/scaling_governor
done

# Using cpupower
cpupower frequency-set -g performance

# Set specific frequency (userspace governor)
cpupower frequency-set -g userspace
cpupower frequency-set -f 2.4GHz

# Set min/max frequencies
echo 2400000 > /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq
echo 3600000 > /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
```

### Intel P-State Driver

```bash
# Check if intel_pstate is active
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_driver
# intel_pstate

# Intel pstate specific controls
ls /sys/devices/system/cpu/intel_pstate/
# max_perf_pct  min_perf_pct  no_turbo  status  turbo_pct

# Disable turbo boost
echo 1 > /sys/devices/system/cpu/intel_pstate/no_turbo

# Set performance limits (percentage of max)
echo 100 > /sys/devices/system/cpu/intel_pstate/max_perf_pct
echo 50 > /sys/devices/system/cpu/intel_pstate/min_perf_pct

# Check turbo frequency range
cat /sys/devices/system/cpu/intel_pstate/turbo_pct
```

---

## CPU Idle States (cpuidle)

### C-States: Idle States

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CPU C-STATES (Idle States)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  C-State    Name           Power        Exit Latency    Description          │
│  ────────────────────────────────────────────────────────────────────────   │
│  C0         Active         High         0 μs            CPU executing        │
│  C1         Halt           Low          1-2 μs          Clock gated         │
│  C1E        Enhanced Halt  Lower        2-5 μs          + voltage reduction │
│  C3         Sleep          Very Low     50-100 μs       L1/L2 flushed       │
│  C6         Deep Sleep     Minimal      100-200 μs      Core off            │
│  C7/C8/C9   Deeper         Ultra Low    200-500 μs      Package states      │
│                                                                              │
│  Trade-off:                                                                  │
│  • Deeper states = more power savings                                       │
│  • Deeper states = higher wake-up latency                                   │
│  • Must balance power vs. latency requirements                              │
│                                                                              │
│  For latency-sensitive apps: Limit to C1/C1E                                │
│  For power efficiency: Allow all C-states                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Viewing C-State Information

```bash
# Available idle states
ls /sys/devices/system/cpu/cpu0/cpuidle/
# state0/ state1/ state2/ state3/

# State details
cat /sys/devices/system/cpu/cpu0/cpuidle/state2/name    # C6
cat /sys/devices/system/cpu/cpu0/cpuidle/state2/latency # 200
cat /sys/devices/system/cpu/cpu0/cpuidle/state2/usage   # 1234567
cat /sys/devices/system/cpu/cpu0/cpuidle/state2/time    # 98765432

# Current governor
cat /sys/devices/system/cpu/cpuidle/current_governor
# menu

# Using turbostat to see C-state residency
sudo turbostat --show Core,CPU,Busy%,Avg_MHz,C1%,C3%,C6%,C7% --interval 1
```

### Limiting C-States for Low Latency

```bash
# Disable deeper C-states (disable state 2 and beyond)
for cpu in /sys/devices/system/cpu/cpu*/cpuidle/state[2-9]; do
    echo 1 > $cpu/disable
done

# Kernel parameter to limit C-states
# Add to GRUB_CMDLINE_LINUX:
intel_idle.max_cstate=1
processor.max_cstate=1

# Using PM QoS to set latency constraint
# Request max 10 microsecond latency
echo 10 > /dev/cpu_dma_latency  # Keeps file open

# Programmatically:
int fd = open("/dev/cpu_dma_latency", O_RDWR);
int latency = 10;  // microseconds
write(fd, &latency, sizeof(latency));
// Keep fd open as long as low latency needed
```

---

## Thermal Management

### Thermal Zones

```bash
# List thermal zones
ls /sys/class/thermal/thermal_zone*/
# thermal_zone0/ thermal_zone1/ ...

# View temperature (millidegrees Celsius)
cat /sys/class/thermal/thermal_zone0/temp
# 45000 (45°C)

# View zone type
cat /sys/class/thermal/thermal_zone0/type
# x86_pkg_temp

# View trip points
cat /sys/class/thermal/thermal_zone0/trip_point_0_temp  # 85000
cat /sys/class/thermal/thermal_zone0/trip_point_0_type  # passive
cat /sys/class/thermal/thermal_zone0/trip_point_1_temp  # 95000
cat /sys/class/thermal/thermal_zone0/trip_point_1_type  # critical
```

### Thermal Trip Points

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    THERMAL TRIP POINTS                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Temperature                                                                 │
│       │                                                                      │
│  95°C ┼───────────────────────────────────────────── CRITICAL               │
│       │                                              • Emergency shutdown   │
│       │                                              • Prevent damage       │
│       │                                                                      │
│  85°C ┼───────────────────────────────────────────── PASSIVE                │
│       │                                              • CPU throttling       │
│       │                                              • Reduce power/freq    │
│       │                                                                      │
│  75°C ┼───────────────────────────────────────────── ACTIVE                 │
│       │                                              • Increase fan speed   │
│       │                                                                      │
│       │                                                                      │
│  45°C ┼───────────────────────────────────────────── NORMAL                 │
│       │                                              • Normal operation     │
│       │                                                                      │
│       └─────────────────────────────────────────────────────────────────►   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Cooling Devices

```bash
# List cooling devices
ls /sys/class/thermal/cooling_device*/

# View cooling device type
cat /sys/class/thermal/cooling_device0/type
# intel_powerclamp
# Processor
# Fan

# Current and max cooling state
cat /sys/class/thermal/cooling_device0/cur_state    # 0
cat /sys/class/thermal/cooling_device0/max_state    # 10

# Which zone is this device bound to?
cat /sys/class/thermal/thermal_zone0/cdev0/type
```

### Monitoring Thermal Throttling

```bash
# Using turbostat
sudo turbostat --show Core,Busy%,Avg_MHz,PkgTmp,PkgWatt --interval 1

# Check for throttling
# MSR_THERM_STATUS (0x19C)
sudo rdmsr 0x19C
# Bit 0: Thermal status (currently throttling)
# Bit 1: Thermal status log (has throttled)

# perf for thermal events
perf stat -e power/energy-pkg/,power/energy-cores/ sleep 10

# Using sensors (lm-sensors package)
sensors
# coretemp-isa-0000
# Core 0:       +45.0°C  (high = +85.0°C, crit = +95.0°C)
```

---

## Power Monitoring

### RAPL (Running Average Power Limit)

```bash
# View power zones
ls /sys/class/powercap/intel-rapl/

# Package power
cat /sys/class/powercap/intel-rapl/intel-rapl:0/name           # package-0
cat /sys/class/powercap/intel-rapl/intel-rapl:0/energy_uj      # Cumulative energy

# DRAM power
cat /sys/class/powercap/intel-rapl/intel-rapl:0/intel-rapl:0:0/name  # dram

# Power constraints (limits)
cat /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_power_limit_uw
cat /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_time_window_us

# Using perf for power events
perf stat -e power/energy-pkg/,power/energy-cores/,power/energy-ram/ ./myapp

# Using turbostat
sudo turbostat --show PkgWatt,CorWatt,RAMWatt --interval 1
```

### Power Capping

```bash
# Set power limit (microwatts)
echo 65000000 > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_power_limit_uw

# Set time window
echo 1000000 > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_time_window_us
```

---

## Performance vs Power Trade-offs

### Latency-Sensitive Workloads

```bash
# Maximum performance configuration
# /etc/tuned/profiles/latency-performance/

# 1. Set performance governor
cpupower frequency-set -g performance

# 2. Disable turbo (for consistent performance)
echo 1 > /sys/devices/system/cpu/intel_pstate/no_turbo

# 3. Disable deep C-states
for state in /sys/devices/system/cpu/cpu*/cpuidle/state[2-9]; do
    echo 1 > $state/disable
done

# 4. Disable frequency scaling (lock to max)
for cpu in /sys/devices/system/cpu/cpu*/cpufreq; do
    cat $cpu/cpuinfo_max_freq > $cpu/scaling_min_freq
done

# 5. Isolate CPUs for application
# GRUB: isolcpus=2-7 nohz_full=2-7
```

### Power-Efficient Workloads

```bash
# Power saving configuration
# 1. Set schedutil governor (balances power/performance)
cpupower frequency-set -g schedutil

# 2. Enable all C-states
for state in /sys/devices/system/cpu/cpu*/cpuidle/state*; do
    echo 0 > $state/disable 2>/dev/null
done

# 3. Enable turbo (uses power when needed, saves when not)
echo 0 > /sys/devices/system/cpu/intel_pstate/no_turbo

# 4. Set power cap if needed
echo 35000000 > /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_power_limit_uw
```

### Using tuned Profiles

```bash
# Install tuned
yum install tuned  # or apt install tuned

# List available profiles
tuned-adm list

# Common profiles:
# balanced           - Default, balance power and performance
# throughput-performance - Maximum throughput
# latency-performance    - Minimum latency
# powersave             - Maximum power savings
# virtual-guest         - Optimized for VMs
# virtual-host          - Optimized for hypervisors

# Set profile
tuned-adm profile latency-performance

# Check current profile
tuned-adm active
```

---

## Cloud and Container Considerations

### Container Power Impact

```bash
# Containers don't directly manage power, but:
# 1. CPU limits affect power indirectly
# 2. Throttled containers waste cycles

# Check if container is being throttled
cat /sys/fs/cgroup/cpu/docker/<container>/cpu.stat
# nr_throttled 12345
# throttled_time 67890123456

# Power-aware scheduling (Kubernetes)
apiVersion: v1
kind: Pod
metadata:
  name: power-aware
spec:
  containers:
  - name: app
    resources:
      requests:
        cpu: "2"       # Request specific cores
      limits:
        cpu: "2"       # Limit to prevent throttling
    # Pin to specific NUMA node for efficiency
    nodeSelector:
      kubernetes.io/numa-node: "0"
```

### Cloud Instance Types

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CLOUD POWER CONSIDERATIONS                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Instance Type        Power Profile          Notes                          │
│  ────────────────────────────────────────────────────────────────────────   │
│  General Purpose      Balanced               C-states enabled, schedutil   │
│  (m5, n2)                                                                   │
│                                                                              │
│  Compute Optimized    Max Performance        Often performance governor    │
│  (c5, c2)             Higher power draw                                    │
│                                                                              │
│  Memory Optimized     Balanced               Large memory, moderate CPU    │
│  (r5, m2)                                                                   │
│                                                                              │
│  Burstable            Power efficient        Credits for bursts           │
│  (t3, e2-micro)       Deep C-states                                       │
│                                                                              │
│  High Frequency       Max single-thread      Turbo boost, high power      │
│  (z1d, c6i.metal)                                                          │
│                                                                              │
│  Spot/Preemptible     Variable               Reclaimed for capacity       │
│                                                                              │
│  Key: Match instance to workload power profile                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Debugging Power Issues

### High CPU Temperature

```bash
# 1. Check current temperature
cat /sys/class/thermal/thermal_zone*/temp

# 2. Check for throttling
sudo turbostat --show Core,Busy%,Avg_MHz,PkgTmp,PkgWatt --interval 1

# 3. Check which process is causing load
top -o %CPU

# 4. Check cooling devices
for cooling in /sys/class/thermal/cooling_device*; do
    echo "$cooling: $(cat $cooling/type) state: $(cat $cooling/cur_state)/$(cat $cooling/max_state)"
done

# 5. Check for thermal trips in logs
dmesg | grep -i thermal
```

### Unexpected Frequency Drops

```bash
# 1. Check if throttling due to temperature
cat /sys/devices/system/cpu/cpu0/thermal_throttle/core_throttle_count

# 2. Check power limits
cat /sys/class/powercap/intel-rapl/intel-rapl:0/constraint_0_power_limit_uw

# 3. Check governor
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor

# 4. Check if turbo is disabled
cat /sys/devices/system/cpu/intel_pstate/no_turbo

# 5. Monitor in real-time
sudo turbostat --show Core,CPU,Avg_MHz,Busy%,Bzy_MHz,TSC_MHz,PkgTmp --interval 1
```

### High Power Consumption

```bash
# 1. Monitor power draw
sudo turbostat --show PkgWatt,CorWatt,RAMWatt --interval 1

# 2. Check which processes are using CPU
perf top

# 3. Check for inefficient C-state usage
cat /sys/devices/system/cpu/cpu*/cpuidle/state*/usage

# 4. Check for unnecessary activity
sudo perf record -g -a sleep 10
sudo perf report
```

---

## Interview Questions

<AccordionGroup>
  <Accordion title="Q: How would you optimize a latency-sensitive application's power management?" icon="question-circle">
    **Answer**:
    
    For latency-sensitive workloads, minimize wake-up latency:
    
    1. **Disable deep C-states**: Prevent 100+ μs wake latencies
    ```bash
    intel_idle.max_cstate=1
    # or disable via /sys/devices/system/cpu/cpu*/cpuidle/state*/disable
    ```
    
    2. **Lock CPU frequency**: Prevent P-state transitions
    ```bash
    cpupower frequency-set -g performance
    # Set min freq = max freq
    ```
    
    3. **Consider disabling turbo**: Turbo varies, causing jitter
    ```bash
    echo 1 > /sys/devices/system/cpu/intel_pstate/no_turbo
    ```
    
    4. **Use PM QoS**: Programmatically request low latency
    ```c
    int fd = open("/dev/cpu_dma_latency", O_RDWR);
    int latency = 0;  // Request zero latency
    write(fd, &latency, sizeof(latency));
    ```
    
    5. **Isolate CPUs**: Prevent kernel interference
    ```bash
    isolcpus=2-7 nohz_full=2-7
    ```
    
    **Trade-off**: Higher power consumption, but consistent low latency.
  </Accordion>
  
  <Accordion title="Q: What causes thermal throttling and how do you detect it?" icon="question-circle">
    **Answer**:
    
    **Causes**:
    - High CPU utilization exceeding TDP
    - Inadequate cooling (failed fan, blocked vents)
    - High ambient temperature
    - Too many active cores at high frequency
    
    **Detection**:
    ```bash
    # Check temperature
    cat /sys/class/thermal/thermal_zone0/temp  # millidegrees
    
    # Check throttle count
    cat /sys/devices/system/cpu/cpu0/thermal_throttle/package_throttle_count
    
    # Real-time monitoring
    sudo turbostat --show Core,CPU,Avg_MHz,PkgTmp --interval 1
    # If Avg_MHz drops when temp is high → throttling
    
    # Check dmesg for thermal warnings
    dmesg | grep -i "thermal\|throttl"
    ```
    
    **Solutions**:
    - Improve cooling (check fans, thermal paste)
    - Reduce power limit via RAPL
    - Spread work across more cores (lower per-core heat)
    - Check for runaway processes
  </Accordion>
  
  <Accordion title="Q: Explain the difference between P-states and C-states" icon="question-circle">
    **Answer**:
    
    **P-states (Performance States)**:
    - Control frequency and voltage when CPU is **active**
    - Higher P-number = lower frequency = lower power
    - Transition time: ~10-100 μs
    - Managed by: cpufreq governors
    
    **C-states (Idle States)**:
    - Control power when CPU is **idle**
    - Higher C-number = deeper sleep = lower power
    - Deeper states take longer to wake from
    - Managed by: cpuidle governors
    
    **When each matters**:
    - **High load**: P-states matter (CPU always active)
    - **Low/variable load**: C-states matter (CPU frequently idle)
    - **Latency-sensitive**: Limit both (avoid transitions)
    
    **Example**: Web server handling requests
    - Between requests: CPU enters C-states (saves power)
    - During request: CPU at appropriate P-state
    - With C6 disabled: Faster wake-up, higher power draw
  </Accordion>
</AccordionGroup>

---

## Summary

| Mechanism | Purpose | Key Files |
|-----------|---------|-----------|
| cpufreq | CPU frequency scaling | `/sys/devices/system/cpu/cpu*/cpufreq/` |
| cpuidle | Idle state management | `/sys/devices/system/cpu/cpu*/cpuidle/` |
| thermal | Temperature monitoring | `/sys/class/thermal/` |
| RAPL | Power limiting/monitoring | `/sys/class/powercap/intel-rapl/` |
| PM QoS | Latency constraints | `/dev/cpu_dma_latency` |
| tuned | Profile-based optimization | `/etc/tuned/profiles/` |

---

## Key Tools

```bash
# Monitor all at once
sudo turbostat --interval 1

# Set power/performance profile
tuned-adm profile <profile-name>

# CPU frequency control
cpupower frequency-set -g performance

# View temperatures
sensors

# Power statistics
perf stat -e power/energy-pkg/ ./myapp
```

---

## Next Steps

- [Process Subsystem →](/courses/linux-internals/process-subsystem) - CPU scheduling and affinity
- [Tracing & Profiling →](/courses/linux-internals/tracing-profiling) - Power analysis with perf
- [Interview Questions →](/courses/linux-internals/interview-questions) - Performance debugging scenarios
