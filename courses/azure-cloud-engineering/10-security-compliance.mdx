---
title: "Security & Compliance"
description: "Master Azure Security Center, Sentinel, and enterprise security patterns"
icon: "shield-halved"
---

# Security & Compliance

Security is not optional. Learn to build secure, compliant Azure environments.

![Azure Defense in Depth](/images/azure/10-defense-in-depth.svg)

---

## 1. Defense in Depth

<div className="flex justify-center my-4">
  <div className="w-full max-w-4xl">
    ```mermaid
    graph TB
        A[Physical Security] --> B[Network Security]
        B --> C[Identity & Access]
        C --> D[Application Security]
        D --> E[Data Security]

        style A fill:#FF6B6B
        style E fill:#51CF66
    ```
    </div>
</div>

> [!TIP]
> **Jargon Alert: Zero Trust**
> The security philosophy of "Never trust, always verify." Just because a request came from "inside the building" (or VNet) doesn't mean it's safe. Every request requires authentication and authorization.

> [!WARNING]
> **Gotcha: Just-In-Time (JIT) VM Access**
> JIT is great for security (closing ports when not in use), but it takes 1-2 minutes to request access and open the port. Do not use this for automated scripts that expect instant connections.

---

## 2. Azure Security Center

**Security Center** provides unified security management and threat protection.

### Security Posture

<CardGroup cols={2}>
  <Card title="Secure Score" icon="star">
    Measure security posture (0-100%)
    - Recommendations with impact
    - Track improvements over time
  </Card>

  <Card title="Regulatory Compliance" icon="clipboard-check">
    Track compliance with standards:
    - PCI DSS
    - ISO 27001
    - HIPAA
    - SOC 2
  </Card>
</CardGroup>

### Key Features

```bash
# Enable Security Center Standard
az security pricing create \
  --name VirtualMachines \
  --tier Standard

# Get security recommendations
az security assessment list

# Enable auto-provisioning (Log Analytics agent)
az security auto-provisioning-setting update \
  --name default \
  --auto-provision On
```

---

## 3. Azure Sentinel (SIEM)

**Sentinel** is Azure's cloud-native SIEM for intelligent security analytics.

### Data Sources

- Azure Activity Logs
- Office 365 Logs
- Firewall Logs
- Threat Intelligence
- Custom Logs

### Example Hunting Query

```kusto
// Detect potential brute force attacks
SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType != 0  // Failed sign-ins
| summarize
    FailedAttempts=count(),
    Locations=make_set(Location)
    by UserPrincipalName, IPAddress
| where FailedAttempts > 5
| project UserPrincipalName, IPAddress, FailedAttempts, Locations
```

---

## 4. Key Vault

**Key Vault** manages secrets, keys, and certificates securely.

```bash
# Create Key Vault
az keyvault create \
  --name myvault \
  --resource-group rg-prod \
  --enable-soft-delete true \
  --enable-purge-protection true

# Add secret
az keyvault secret set \
  --vault-name myvault \
  --name DatabasePassword \
  --value "SuperSecretPassword123!"

# Access from application (using Managed Identity)
SecretClient client = new SecretClient(
    new Uri("https://myvault.vault.azure.net"),
    new DefaultAzureCredential()
);

KeyVaultSecret secret = await client.GetSecretAsync("DatabasePassword");
string password = secret.Value;
```

---

## 5. Azure Policy

**Azure Policy** enforces organizational standards and compliance.

### Example Policies

```json
{
  "displayName": "Require tag on resources",
  "policyRule": {
    "if": {
      "field": "tags['Environment']",
      "exists": "false"
    },
    "then": {
      "effect": "deny"
    }
  }
}
```

```bash
# Assign built-in policy
az policy assignment create \
  --name require-tags \
  --scope /subscriptions/{subscription-id} \
  --policy /providers/Microsoft.Authorization/policyDefinitions/...

# Common policies:
# - Allowed VM sizes
# - Require encryption
# - Enforce naming conventions
# - Geographic restrictions
```

---

## 6. Security Best Practices

<CardGroup cols={2}>
  <Card title="Zero Trust" icon="ban">
    Never trust, always verify. Verify explicitly, least privilege, assume breach.
  </Card>

  <Card title="Encryption Everywhere" icon="lock">
    Data at rest, in transit, and in use. Customer-managed keys for sensitive data.
  </Card>

  <Card title="Network Isolation" icon="network-wired">
    Private endpoints, NSGs, Azure Firewall. No public IPs on backends.
  </Card>

  <Card title="Identity is Perimeter" icon="user-shield">
    MFA, Conditional Access, PIM. Azure AD for all authentication.
  </Card>

  <Card title="Monitor Everything" icon="eye">
    All logs to Log Analytics. Alerts on suspicious activity.
  </Card>

  <Card title="Incident Response" icon="siren">
    Have a plan, test regularly, document lessons learned.
  </Card>
</CardGroup>

---

## 7. Advanced Security Patterns

### Web Application Firewall (WAF) Configuration

Azure WAF protects against OWASP Top 10 vulnerabilities. Available on Azure Front Door and Application Gateway.

#### WAF Policy with Custom Rules

```bash
# Create WAF policy
az network front-door waf-policy create \
  --name MyWAFPolicy \
  --resource-group rg-prod \
  --mode Prevention \
  --sku Premium_AzureFrontDoor

# Enable OWASP ruleset
az network front-door waf-policy managed-rules add \
  --policy-name MyWAFPolicy \
  --resource-group rg-prod \
  --type Microsoft_DefaultRuleSet \
  --version 2.1

# Enable Bot Manager rules
az network front-door waf-policy managed-rules add \
  --policy-name MyWAFPolicy \
  --resource-group rg-prod \
  --type Microsoft_BotManagerRuleSet \
  --version 1.0
```

#### Custom Rule: Block Traffic from Specific Countries

```json
{
  "name": "BlockBadCountries",
  "priority": 1,
  "ruleType": "MatchRule",
  "matchConditions": [
    {
      "matchVariable": "RemoteAddr",
      "operator": "GeoMatch",
      "matchValue": ["CN", "RU", "KP"]
    }
  ],
  "action": "Block"
}
```

#### Custom Rule: Rate Limiting

```json
{
  "name": "RateLimitPerIP",
  "priority": 10,
  "ruleType": "RateLimitRule",
  "rateLimitThreshold": 100,
  "rateLimitDurationInMinutes": 1,
  "matchConditions": [
    {
      "matchVariable": "RemoteAddr",
      "operator": "IPMatch",
      "matchValue": ["0.0.0.0/0"]
    }
  ],
  "action": "Block"
}
```

> [!WARNING]
> **Gotcha: WAF False Positives**
> OWASP rules might block legitimate requests (e.g., SQL keywords in user input). Always test in **Detection Mode** first, review logs, then switch to **Prevention Mode**. Create exclusions for known false positives.

**Real-World Example**: An API endpoint `/search?query=SELECT * FROM products` gets blocked by WAF because "SELECT" triggers SQL injection detection. Solution: Add exclusion for that specific query parameter.

---

### DDoS Protection Strategies

#### Azure DDoS Protection Standard

```bash
# Create DDoS protection plan
az network ddos-protection create \
  --resource-group rg-prod \
  --name MyDDoSPlan

# Enable on VNet
az network vnet update \
  --resource-group rg-prod \
  --name myVNet \
  --ddos-protection true \
  --ddos-protection-plan MyDDoSPlan
```

**DDoS Protection Tiers**:

| Feature | Basic (Free) | Standard ($2,944/month) |
|---------|--------------|-------------------------|
| Always-On Monitoring | ✅ | ✅ |
| L3/L4 Attack Mitigation | ✅ | ✅ |
| Adaptive Tuning | ❌ | ✅ (Per workload) |
| Application Layer Protection | ❌ | ✅ (with WAF) |
| Cost Protection | ❌ | ✅ (Azure credits) |
| Real-time Metrics | ❌ | ✅ |
| DDoS Rapid Response Support | ❌ | ✅ |

#### Monitoring DDoS Attacks

```kusto
// Azure Monitor query for DDoS metrics
AzureMetrics
| where ResourceProvider == "MICROSOFT.NETWORK"
| where MetricName in ("DDoSAttack", "VipAvailability")
| where TimeGenerated > ago(24h)
| summarize
    MaxAttack = max(Maximum),
    AvgAvailability = avg(Average)
    by Resource, MetricName
| project
    Resource,
    MaxAttackIntensity = MaxAttack,
    AvailabilityPercent = AvgAvailability
```

> [!TIP]
> **Best Practice: Multi-Layer DDoS Defense**
> Combine Azure DDoS Protection (L3/L4) with Azure Front Door WAF (L7) for comprehensive protection. DDoS handles volumetric attacks; WAF handles application-layer attacks.

---

### Zero Trust Implementation

**Zero Trust Principles**:
1. **Verify Explicitly** - Always authenticate and authorize
2. **Use Least Privilege** - Just-in-time and just-enough-access
3. **Assume Breach** - Minimize blast radius and verify end-to-end encryption

#### Conditional Access Policies

```bash
# Enable Conditional Access requiring MFA for admins
az rest --method POST \
  --uri "https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies" \
  --body '{
    "displayName": "Require MFA for Admins",
    "state": "enabled",
    "conditions": {
      "users": {
        "includeRoles": ["62e90394-69f5-4237-9190-012177145e10"]
      },
      "applications": {
        "includeApplications": ["All"]
      }
    },
    "grantControls": {
      "operator": "AND",
      "builtInControls": ["mfa"]
    }
  }'
```

#### Risk-Based Access with Identity Protection

```json
{
  "displayName": "Block High-Risk Sign-Ins",
  "conditions": {
    "signInRiskLevels": ["high"],
    "userRiskLevels": ["none", "low", "medium"]
  },
  "grantControls": {
    "operator": "OR",
    "builtInControls": ["block"]
  }
}
```

**Impossible Travel Detection**:
```kusto
// Sentinel query: Detect user signing in from 2 countries within 1 hour
SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType == 0  // Successful sign-ins
| summarize
    Locations = make_set(Location),
    Count = count()
    by UserPrincipalName, bin(TimeGenerated, 1h)
| where Count > 1 and array_length(Locations) > 1
| extend
    Distance = geo_distance_2points(
        toreal(Locations[0].latitude), toreal(Locations[0].longitude),
        toreal(Locations[1].latitude), toreal(Locations[1].longitude)
    )
| where Distance > 1000000  // 1000 km
```

---

### Privileged Identity Management (PIM)

**Problem**: Admins have permanent elevated access. If their account is compromised, attacker has full control.

**Solution**: Just-in-time (JIT) access. Admins activate privileges only when needed, with approval workflow.

#### Enable PIM for Azure Resources

```bash
# Assign eligible role (not active)
az role assignment create \
  --assignee user@example.com \
  --role "Virtual Machine Contributor" \
  --scope /subscriptions/{subscription-id} \
  --assignee-object-id {user-object-id} \
  --assignee-principal-type User \
  --description "JIT access for VM maintenance"
```

#### Activation Workflow

```json
{
  "roleDefinitionId": "/subscriptions/.../providers/Microsoft.Authorization/roleDefinitions/...",
  "principalId": "user-object-id",
  "requestType": "SelfActivate",
  "scheduleInfo": {
    "startDateTime": "2026-01-21T10:00:00Z",
    "expiration": {
      "type": "AfterDuration",
      "duration": "PT8H"
    }
  },
  "justification": "Need to troubleshoot production VM issue #12345"
}
```

**Access Review**:
```bash
# Create recurring access review (quarterly)
az ad pim access-review create \
  --name "Review Global Admins" \
  --start-date "2026-01-21" \
  --interval 3 \
  --reviewers "manager@example.com"
```

> [!WARNING]
> **Gotcha: Emergency Access Account**
> Always have a "break glass" account (excluded from MFA and Conditional Access) for emergencies. Store credentials in physical safe. Use Azure Monitor alerts if this account is ever used.

---

### Threat Detection with Sentinel

#### Advanced Threat Detection Rules

**Detect Crypto Mining**:
```kusto
// High CPU + Outbound connections to known mining pools
Perf
| where TimeGenerated > ago(1h)
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| where CounterValue > 80
| join kind=inner (
    CommonSecurityLog
    | where TimeGenerated > ago(1h)
    | where DestinationIP in ("45.76.13.12", "pool.minexmr.com", "xmr.pool.minergate.com")
) on Computer
| project Computer, CounterValue, DestinationIP, Activity
```

**Detect Credential Dumping (Mimikatz)**:
```kusto
SecurityEvent
| where TimeGenerated > ago(1h)
| where EventID == 4688  // Process creation
| where Process has_any ("mimikatz", "procdump", "gsecdump")
    or CommandLine has_any ("sekurlsa::logonpasswords", "lsass.exe")
| project TimeGenerated, Computer, Account, Process, CommandLine
```

**Detect Data Exfiltration**:
```kusto
// Unusual volume of data uploaded to external storage
AzureActivity
| where TimeGenerated > ago(1h)
| where OperationNameValue == "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write"
| summarize
    TotalSizeMB = sum(todouble(Properties.contentLength)) / 1024 / 1024,
    FileCount = count()
    by Caller, CallerIpAddress
| where TotalSizeMB > 1000  // More than 1GB
```

#### Automated Response Playbooks

```json
{
  "definition": {
    "triggers": {
      "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
        "type": "MicrosoftSentinelIncident"
      }
    },
    "actions": {
      "Check_if_severity_is_high": {
        "type": "If",
        "expression": "@equals(triggerBody()?['Severity'], 'High')",
        "actions": {
          "Disable_user_account": {
            "type": "ApiConnection",
            "inputs": {
              "host": {
                "connection": {
                  "name": "@parameters('$connections')['azuread']['connectionId']"
                }
              },
              "method": "post",
              "path": "/v1.0/users/@{triggerBody()?['CompromisedEntity']}/accountEnabled",
              "body": { "accountEnabled": false }
            }
          },
          "Send_email_to_SOC": {
            "type": "ApiConnection",
            "inputs": {
              "host": { "connection": { "name": "@parameters('$connections')['office365']" } },
              "method": "post",
              "path": "/v2/Mail",
              "body": {
                "To": "soc@company.com",
                "Subject": "High Severity Incident: @{triggerBody()?['Title']}",
                "Body": "Account @{triggerBody()?['CompromisedEntity']} has been disabled."
              }
            }
          }
        }
      }
    }
  }
}
```

---

### Network Security Deep Dive

#### Private Endpoint + Private Link

**Problem**: Azure SQL, Storage, etc. have public endpoints. Even with firewall rules, they're exposed to the internet.

**Solution**: Private Endpoint maps PaaS services to a private IP in your VNet.

```bash
# Create private endpoint for Azure SQL
az network private-endpoint create \
  --resource-group rg-prod \
  --name pe-sql \
  --vnet-name myVNet \
  --subnet data-subnet \
  --private-connection-resource-id /subscriptions/.../sqlservers/myserver \
  --group-id sqlServer \
  --connection-name sql-connection

# Create Private DNS Zone
az network private-dns zone create \
  --resource-group rg-prod \
  --name privatelink.database.windows.net

# Link DNS zone to VNet
az network private-dns link vnet create \
  --resource-group rg-prod \
  --zone-name privatelink.database.windows.net \
  --name sql-dns-link \
  --virtual-network myVNet \
  --registration-enabled false
```

**Result**: `myserver.database.windows.net` now resolves to `10.0.2.5` (private IP) instead of public IP.

#### Azure Firewall Configuration

```bash
# Create Azure Firewall
az network firewall create \
  --name MyFirewall \
  --resource-group rg-prod \
  --location eastus \
  --sku AZFW_VNet \
  --tier Premium

# Application rule: Allow HTTPS to specific domains
az network firewall application-rule create \
  --firewall-name MyFirewall \
  --resource-group rg-prod \
  --collection-name allow-microsoft \
  --name allow-microsoft-sites \
  --protocols Https=443 \
  --source-addresses 10.0.0.0/16 \
  --target-fqdns "*.microsoft.com" "*.azure.com"

# Network rule: Block all except DNS and NTP
az network firewall network-rule create \
  --firewall-name MyFirewall \
  --collection-name allow-dns-ntp \
  --name allow-infrastructure \
  --protocols UDP \
  --source-addresses 10.0.0.0/16 \
  --destination-addresses "*" \
  --destination-ports 53 123
```

#### User Defined Routes (Force Tunneling)

```bash
# Create route table
az network route-table create \
  --resource-group rg-prod \
  --name rt-firewall

# Add route: All internet traffic → Firewall
az network route-table route create \
  --resource-group rg-prod \
  --route-table-name rt-firewall \
  --name default-route \
  --address-prefix 0.0.0.0/0 \
  --next-hop-type VirtualAppliance \
  --next-hop-ip-address 10.0.1.4  # Firewall private IP

# Associate with subnet
az network vnet subnet update \
  --resource-group rg-prod \
  --vnet-name myVNet \
  --name app-subnet \
  --route-table rt-firewall
```

---

### Security Monitoring & Alerts

#### Critical Security Alerts

```kusto
// Alert: Admin role assigned outside business hours
AuditLogs
| where TimeGenerated > ago(1h)
| where OperationName == "Add member to role"
| where Result == "success"
| extend Role = tostring(TargetResources[0].displayName)
| where Role in ("Global Administrator", "Security Administrator")
| extend Hour = hourofday(TimeGenerated)
| where Hour < 6 or Hour > 22  // Outside 6 AM - 10 PM
| project TimeGenerated, Caller = Identity, Role, TargetUser = TargetResources[0].userPrincipalName
```

```kusto
// Alert: Large number of resources deleted
AzureActivity
| where TimeGenerated > ago(1h)
| where OperationNameValue endswith "/delete"
| summarize DeleteCount = count() by Caller, CallerIpAddress
| where DeleteCount > 10
```

---

### Security Checklist for Production

Before going live, ensure:

- [ ] **Identity**: MFA enabled for all admin accounts
- [ ] **Identity**: Conditional Access policies active (block legacy auth, require compliant devices)
- [ ] **Identity**: PIM enabled for privileged roles (no standing access)
- [ ] **Network**: No public IPs on backend VMs
- [ ] **Network**: Private Endpoints for all PaaS services (SQL, Storage, Key Vault)
- [ ] **Network**: Azure Firewall or NVA with forced tunneling
- [ ] **Network**: NSGs on all subnets (deny all by default)
- [ ] **Application**: WAF enabled on Front Door/App Gateway (Prevention mode)
- [ ] **Application**: DDoS Protection Standard (for critical apps)
- [ ] **Application**: All secrets in Key Vault (no config files)
- [ ] **Data**: TDE enabled on databases
- [ ] **Data**: Customer-Managed Keys (CMK) for sensitive data
- [ ] **Monitoring**: All logs flowing to Log Analytics
- [ ] **Monitoring**: Sentinel enabled with threat detection rules
- [ ] **Monitoring**: Alerts for suspicious activity (failed sign-ins, admin actions, data exfiltration)
- [ ] **Compliance**: Azure Policy enforcing standards (tagging, allowed regions, encryption)
- [ ] **Incident Response**: Runbook documented and tested

---

## 8. Interview Questions

### Beginner Level

<AccordionGroup>
  <Accordion title="Q1: What is the difference between Azure Policy and RBAC?">
    **Answer**:
    - **RBAC**: Controls *WHO* can do what (User Alice can create VMs). Focus: User Actions.
    - **Azure Policy**: Controls *WHAT* can be created (VMs must be in East US). Focus: Resource Properties.
    
    *RBAC allows access; Policy limits what that access can generate.*
  </Accordion>

  <Accordion title="Q2: What is the purpose of a Key Vault?">
    **Answer**:
    To securely store and manage:
    1. **Secrets** (Passwords, Connection strings)
    2. **Keys** (Encryption keys)
    3. **Certificates** (SSL/TLS certs)
    
    It decouples security material from application code.
  </Accordion>
</AccordionGroup>

### Intermediate Level

<AccordionGroup>
  <Accordion title="Q3: Explain Defense in Depth">
    **Answer**:
    A security strategy using multiple layers of defense, so if one fails, others provide protection.
    Layers: Physical -> Identity -> Networking -> Compute -> Application -> Data.
    *Example: Even if a hacker gets past the Firewall (Network), they still need MFA (Identity) and Database encryption (Data).*
  </Accordion>

  <Accordion title="Q4: Describe how Azure Sentinel works">
    **Answer**:
    Sentinel is a **Cloud-Native SIEM (Security Information and Event Management)** + **SOAR (Security Orchestration, Automation, and Response)**.
    1. **Collect**: Ingests logs from everywhere (Azure, AWS, On-prem firewall).
    2. **Detect**: Uses AI/ML rules to find threat patterns (e.g., Impossible Travel).
    3. **Investigate**: Visualizes the attack timeline.
    4. **Respond**: Triggers automated playbooks (e.g., block IP, disable user).
  </Accordion>
</AccordionGroup>

### Advanced Level

<AccordionGroup>
  <Accordion title="Q5: How do you secure a public-facing web application on Azure?">
    **Answer**:
    1. **Front Door/WAF**: Filter malicious traffic (SQLi, XSS) at the edge.
    2. **DDoS Protection**: Enable standard protection if critical.
    3. **Network**: Use VNet injection, deny all inbound except from WAF.
    4. **Identity**: Use Managed Identity for backend resources.
    5. **Data**: Encrypt SQL with TDE and CMK (Customer Managed Keys).
    6. **Secrets**: Store all secrets in Key Vault.
    7. **Monitoring**: Enable App Insights and Sentinel.
  </Accordion>
</AccordionGroup>

---

## 8. Key Takeaways

<CardGroup cols={2}>
  <Card title="Zero Trust" icon="shield-halved">
    Assume breach. Verify every request explicitly. Use least privilege access.
  </Card>
  <Card title="Azure Policy" icon="gavel">
    Use Policy to enforce compliance (e.g., Tagging, Regions) and prevent configuration drift.
  </Card>
  <Card title="Centralized Security" icon="tower-observation">
    Use **Azure Security Center (Defender for Cloud)** and **Sentinel** for a unified view of security posture.
  </Card>
  <Card title="Key Vault" icon="key">
    Never store credentials in config files or code. Centralize them in Key Vault.
  </Card>
  <Card title="Defense in Depth" icon="layer-group">
    Layer security controls. Don't rely on a single perimeter firewall.
  </Card>
</CardGroup>

---

## Next Steps

<Card title="Continue to Chapter 11" icon="arrow-right" href="/courses/azure-cloud-engineering/11-devops-cicd">
  Master Azure DevOps, CI/CD pipelines, and Infrastructure as Code
</Card>
