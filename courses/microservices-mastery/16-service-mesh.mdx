---
title: "16. Service Mesh"
description: "Master service mesh architecture with Istio and Linkerd for advanced traffic management, security, and observability"
---

# Service Mesh

A service mesh provides infrastructure-layer functionality for service-to-service communication, taking networking concerns out of your application code.

<Info>
**Learning Objectives:**
- Understand service mesh architecture and benefits
- Implement Istio for traffic management
- Configure mTLS automation
- Set up advanced traffic patterns (canary, A/B testing)
- Compare Istio vs Linkerd
</Info>

---

## What is a Service Mesh?

### The Problem

As microservices grow, managing cross-cutting concerns becomes complex:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WITHOUT SERVICE MESH                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚                    Service A                          â”‚                  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚
â”‚  â”‚  â”‚              Application Code                   â”‚  â”‚                  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                  â”‚
â”‚  â”‚  â”‚  + Retry Logic                                  â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  + Circuit Breaker                              â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  + Load Balancing                               â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  + TLS/mTLS                                     â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  + Metrics Collection                           â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  + Tracing                                      â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  + Rate Limiting                                â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  + Service Discovery                            â”‚  â”‚                  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                              â”‚
â”‚  âš ï¸ Problems:                                                                â”‚
â”‚  â€¢ Every service needs same networking code                                 â”‚
â”‚  â€¢ Different languages = different implementations                          â”‚
â”‚  â€¢ Hard to update consistently                                              â”‚
â”‚  â€¢ Application developers handle infrastructure                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WITH SERVICE MESH                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚                    Service A                          â”‚                  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚
â”‚  â”‚  â”‚              Application Code                   â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚         (Pure Business Logic Only)              â”‚  â”‚                  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚
â”‚  â”‚  â”‚              Sidecar Proxy (Envoy)              â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  âœ“ Retry, Circuit Breaker, Load Balancing      â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  âœ“ mTLS, Auth, Rate Limiting                   â”‚  â”‚                  â”‚
â”‚  â”‚  â”‚  âœ“ Metrics, Tracing, Logging                   â”‚  â”‚                  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                              â”‚
â”‚  âœ… Benefits:                                                                â”‚
â”‚  â€¢ Networking handled by infrastructure                                     â”‚
â”‚  â€¢ Language agnostic                                                        â”‚
â”‚  â€¢ Centralized policy management                                            â”‚
â”‚  â€¢ Consistent across all services                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Service Mesh Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SERVICE MESH ARCHITECTURE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                         â”‚    CONTROL PLANE     â”‚                            â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                            â”‚
â”‚                         â”‚  â”‚   Pilot/Istiod â”‚  â”‚ â† Configuration           â”‚
â”‚                         â”‚  â”‚   (Config)     â”‚  â”‚                            â”‚
â”‚                         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                            â”‚
â”‚                         â”‚  â”‚    Citadel     â”‚  â”‚ â† Certificate Mgmt        â”‚
â”‚                         â”‚  â”‚   (Security)   â”‚  â”‚                            â”‚
â”‚                         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                            â”‚
â”‚                         â”‚  â”‚    Galley      â”‚  â”‚ â† Validation              â”‚
â”‚                         â”‚  â”‚  (Validation)  â”‚  â”‚                            â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                    â”‚                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚              â”‚                     â”‚                     â”‚                  â”‚
â”‚              â–¼                     â–¼                     â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚    Service A      â”‚ â”‚    Service B      â”‚ â”‚    Service C      â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚    App      â”‚  â”‚ â”‚  â”‚    App      â”‚  â”‚ â”‚  â”‚    App      â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚         â”‚         â”‚ â”‚         â”‚         â”‚ â”‚         â”‚         â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚   Envoy     â”‚â—€â”€â”¼â”€â”¼â”€â–¶â”‚   Envoy     â”‚â—€â”€â”¼â”€â”¼â”€â–¶â”‚   Envoy     â”‚  â”‚         â”‚
â”‚  â”‚  â”‚  (Sidecar)  â”‚  â”‚ â”‚  â”‚  (Sidecar)  â”‚  â”‚ â”‚  â”‚  (Sidecar)  â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                          DATA PLANE                                         â”‚
â”‚                  (Sidecar Proxies - Envoy)                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Istio Deep Dive

### Installing Istio

```bash
# Download Istio
curl -L https://istio.io/downloadIstio | sh -
cd istio-1.20.0
export PATH=$PWD/bin:$PATH

# Install with demo profile (includes all features)
istioctl install --set profile=demo -y

# Enable automatic sidecar injection for default namespace
kubectl label namespace default istio-injection=enabled

# Verify installation
kubectl get pods -n istio-system
```

### Deploying a Service with Istio

```yaml
# deployment.yaml - No changes needed, Istio injects sidecar automatically
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  labels:
    app: order-service
    version: v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: order-service
      version: v1
  template:
    metadata:
      labels:
        app: order-service
        version: v1
    spec:
      containers:
      - name: order-service
        image: myregistry/order-service:v1
        ports:
        - containerPort: 3000
        env:
        - name: PORT
          value: "3000"
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
---
apiVersion: v1
kind: Service
metadata:
  name: order-service
  labels:
    app: order-service
spec:
  ports:
  - port: 80
    targetPort: 3000
    name: http
  selector:
    app: order-service
```

### Traffic Management

#### Virtual Services

Control how requests are routed:

```yaml
# virtual-service.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service
spec:
  hosts:
  - order-service
  http:
  # Route based on headers
  - match:
    - headers:
        x-user-type:
          exact: premium
    route:
    - destination:
        host: order-service
        subset: v2  # Premium users get v2
  # Default route
  - route:
    - destination:
        host: order-service
        subset: v1
      weight: 90  # 90% to v1
    - destination:
        host: order-service
        subset: v2
      weight: 10  # 10% canary to v2
    timeout: 10s
    retries:
      attempts: 3
      perTryTimeout: 3s
      retryOn: 5xx,reset,connect-failure
```

#### Destination Rules

Define subsets and policies:

```yaml
# destination-rule.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: order-service
spec:
  host: order-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    loadBalancer:
      simple: LEAST_CONN  # ROUND_ROBIN, RANDOM, PASSTHROUGH
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      connectionPool:
        http:
          http1MaxPendingRequests: 50
  - name: v2
    labels:
      version: v2
```

### Canary Deployments with Istio

```yaml
# Step 1: Deploy v2 alongside v1
# canary-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service-v2
spec:
  replicas: 1  # Start with 1 replica
  selector:
    matchLabels:
      app: order-service
      version: v2
  template:
    metadata:
      labels:
        app: order-service
        version: v2
    spec:
      containers:
      - name: order-service
        image: myregistry/order-service:v2
        ports:
        - containerPort: 3000
---
# Step 2: Route 10% traffic to v2
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service-canary
spec:
  hosts:
  - order-service
  http:
  - route:
    - destination:
        host: order-service
        subset: v1
      weight: 90
    - destination:
        host: order-service
        subset: v2
      weight: 10
```

Progressive rollout script:

```javascript
// scripts/canary-rollout.js
const k8s = require('@kubernetes/client-node');

class CanaryRollout {
  constructor(serviceName, namespace = 'default') {
    this.serviceName = serviceName;
    this.namespace = namespace;
    
    const kc = new k8s.KubeConfig();
    kc.loadFromDefault();
    this.customApi = kc.makeApiClient(k8s.CustomObjectsApi);
  }

  async updateTrafficSplit(v1Weight, v2Weight) {
    const virtualService = {
      apiVersion: 'networking.istio.io/v1beta1',
      kind: 'VirtualService',
      metadata: {
        name: `${this.serviceName}-canary`,
        namespace: this.namespace
      },
      spec: {
        hosts: [this.serviceName],
        http: [{
          route: [
            {
              destination: {
                host: this.serviceName,
                subset: 'v1'
              },
              weight: v1Weight
            },
            {
              destination: {
                host: this.serviceName,
                subset: 'v2'
              },
              weight: v2Weight
            }
          ]
        }]
      }
    };

    try {
      await this.customApi.patchNamespacedCustomObject(
        'networking.istio.io',
        'v1beta1',
        this.namespace,
        'virtualservices',
        `${this.serviceName}-canary`,
        virtualService,
        undefined,
        undefined,
        undefined,
        { headers: { 'Content-Type': 'application/merge-patch+json' } }
      );
      console.log(`Traffic split updated: v1=${v1Weight}%, v2=${v2Weight}%`);
    } catch (error) {
      console.error('Failed to update traffic split:', error);
      throw error;
    }
  }

  async progressiveRollout(steps = [10, 25, 50, 75, 100], intervalMinutes = 5) {
    for (const v2Percentage of steps) {
      const v1Percentage = 100 - v2Percentage;
      
      console.log(`\nğŸš€ Rolling out: ${v2Percentage}% to v2`);
      await this.updateTrafficSplit(v1Percentage, v2Percentage);
      
      // Wait and monitor
      console.log(`â³ Waiting ${intervalMinutes} minutes before next step...`);
      console.log('ğŸ“Š Monitor metrics at: http://localhost:3000/grafana');
      
      if (v2Percentage < 100) {
        await this.waitAndMonitor(intervalMinutes);
        
        // Check error rates before continuing
        const healthy = await this.checkHealth();
        if (!healthy) {
          console.log('âŒ Health check failed! Rolling back...');
          await this.rollback();
          return false;
        }
      }
    }
    
    console.log('\nâœ… Canary rollout complete! v2 receiving 100% traffic');
    return true;
  }

  async rollback() {
    console.log('ğŸ”„ Rolling back to v1...');
    await this.updateTrafficSplit(100, 0);
    console.log('âœ… Rollback complete. All traffic to v1');
  }

  async waitAndMonitor(minutes) {
    const ms = minutes * 60 * 1000;
    await new Promise(resolve => setTimeout(resolve, ms));
  }

  async checkHealth() {
    // Query Prometheus for error rates
    try {
      const response = await fetch(
        `http://prometheus:9090/api/v1/query?query=` +
        `sum(rate(istio_requests_total{destination_service="${this.serviceName}",` +
        `response_code=~"5.*",destination_version="v2"}[5m]))` +
        `/ sum(rate(istio_requests_total{destination_service="${this.serviceName}",` +
        `destination_version="v2"}[5m]))`
      );
      
      const data = await response.json();
      const errorRate = parseFloat(data.data.result[0]?.value[1] || 0);
      
      console.log(`ğŸ“ˆ v2 error rate: ${(errorRate * 100).toFixed(2)}%`);
      return errorRate < 0.01; // Less than 1% error rate
    } catch (error) {
      console.log('âš ï¸ Could not fetch metrics, continuing...');
      return true;
    }
  }
}

// Usage
const canary = new CanaryRollout('order-service');
canary.progressiveRollout([10, 25, 50, 75, 100], 5);
```

### mTLS (Mutual TLS)

Automatic encryption between services:

```yaml
# peer-authentication.yaml - Enable strict mTLS
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default
spec:
  mtls:
    mode: STRICT  # PERMISSIVE allows plaintext, STRICT requires mTLS
---
# authorization-policy.yaml - Service-to-service authorization
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: order-service-policy
  namespace: default
spec:
  selector:
    matchLabels:
      app: order-service
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - "cluster.local/ns/default/sa/api-gateway"
        - "cluster.local/ns/default/sa/payment-service"
    to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/api/v1/orders/*"]
  - from:
    - source:
        principals:
        - "cluster.local/ns/monitoring/sa/prometheus"
    to:
    - operation:
        methods: ["GET"]
        paths: ["/metrics"]
```

### Circuit Breaking with Istio

```yaml
# circuit-breaker.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: payment-service-circuit-breaker
spec:
  host: payment-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100  # Max TCP connections
      http:
        http1MaxPendingRequests: 100  # Queue size
        http2MaxRequests: 1000  # Max concurrent requests
        maxRequestsPerConnection: 10  # Connection reuse
        maxRetries: 3  # Max retries
    outlierDetection:
      # Circuit breaker configuration
      consecutive5xxErrors: 5  # Eject after 5 consecutive 5xx
      consecutiveGatewayErrors: 5  # Eject after 5 gateway errors
      interval: 10s  # Detection interval
      baseEjectionTime: 30s  # Base ejection time
      maxEjectionPercent: 50  # Max % of hosts to eject
      minHealthPercent: 30  # Min healthy hosts before breaking
```

### Rate Limiting

```yaml
# rate-limit.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: api-rate-limit
  namespace: default
spec:
  workloadSelector:
    labels:
      app: api-gateway
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.local_ratelimit
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
          value:
            stat_prefix: http_local_rate_limiter
            token_bucket:
              max_tokens: 1000
              tokens_per_fill: 100
              fill_interval: 1s
            filter_enabled:
              runtime_key: local_rate_limit_enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            filter_enforced:
              runtime_key: local_rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
            response_headers_to_add:
            - append: false
              header:
                key: x-rate-limit-remaining
                value: "%DYNAMIC_METADATA(envoy.filters.http.local_ratelimit:remaining_tokens)%"
```

---

## Istio vs Linkerd Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ISTIO vs LINKERD COMPARISON                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Feature              â”‚ Istio                  â”‚ Linkerd                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Proxy                â”‚ Envoy (C++)            â”‚ linkerd2-proxy (Rust)      â”‚
â”‚  Resource Usage       â”‚ Higher                 â”‚ Lower (~10x less)          â”‚
â”‚  Latency Overhead     â”‚ ~2-3ms                 â”‚ ~1ms                       â”‚
â”‚  Complexity           â”‚ High                   â”‚ Low                        â”‚
â”‚  Learning Curve       â”‚ Steep                  â”‚ Gentle                     â”‚
â”‚  Features             â”‚ Very extensive         â”‚ Focused, simpler           â”‚
â”‚  mTLS                 â”‚ Yes                    â”‚ Yes (default on)           â”‚
â”‚  Traffic Management   â”‚ Advanced               â”‚ Basic                      â”‚
â”‚  Multi-cluster        â”‚ Yes                    â”‚ Yes                        â”‚
â”‚  Web UI               â”‚ Kiali (separate)       â”‚ Built-in dashboard         â”‚
â”‚  Best For             â”‚ Large enterprises      â”‚ Kubernetes-native teams    â”‚
â”‚                                                                              â”‚
â”‚  Choose Istio if:                                                           â”‚
â”‚  â€¢ Need advanced traffic management                                         â”‚
â”‚  â€¢ Already using Envoy                                                      â”‚
â”‚  â€¢ Enterprise with complex requirements                                     â”‚
â”‚  â€¢ Need extensive customization                                             â”‚
â”‚                                                                              â”‚
â”‚  Choose Linkerd if:                                                         â”‚
â”‚  â€¢ Want simplicity and low overhead                                         â”‚
â”‚  â€¢ Kubernetes-only environment                                              â”‚
â”‚  â€¢ Need quick implementation                                                â”‚
â”‚  â€¢ Resource-constrained clusters                                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Linkerd Quick Start

```bash
# Install Linkerd CLI
curl -fsL https://run.linkerd.io/install | sh
export PATH=$PATH:$HOME/.linkerd2/bin

# Validate cluster
linkerd check --pre

# Install Linkerd
linkerd install | kubectl apply -f -
linkerd check

# Inject sidecar into deployment
kubectl get deploy order-service -o yaml | linkerd inject - | kubectl apply -f -

# Or enable auto-injection for namespace
kubectl annotate namespace default linkerd.io/inject=enabled

# Access dashboard
linkerd viz install | kubectl apply -f -
linkerd viz dashboard &
```

---

## Observability with Service Mesh

### Automatic Metrics

Istio automatically generates:

```promql
# Request rate by service
sum(rate(istio_requests_total{reporter="destination"}[5m])) by (destination_service_name)

# Error rate
sum(rate(istio_requests_total{reporter="destination",response_code=~"5.*"}[5m])) 
  by (destination_service_name)
/ 
sum(rate(istio_requests_total{reporter="destination"}[5m])) 
  by (destination_service_name)

# P99 latency
histogram_quantile(0.99, 
  sum(rate(istio_request_duration_milliseconds_bucket{reporter="destination"}[5m])) 
  by (destination_service_name, le)
)

# Traffic between services
sum(rate(istio_requests_total{reporter="source"}[5m])) 
  by (source_workload, destination_service_name)
```

### Distributed Tracing Integration

```yaml
# Enable tracing with Jaeger
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: istio-config
spec:
  meshConfig:
    enableTracing: true
    defaultConfig:
      tracing:
        sampling: 100.0  # 100% sampling for dev, reduce in prod
        zipkin:
          address: jaeger-collector.istio-system.svc:9411
```

---

## Service Mesh Interview Questions

<AccordionGroup>
  <Accordion title="Q1: What is a service mesh and when would you use one?">
    **Answer:**
    
    A service mesh is an infrastructure layer that handles service-to-service communication, providing:
    - **Traffic management**: Load balancing, routing, retries
    - **Security**: mTLS, authorization
    - **Observability**: Metrics, tracing, logging
    
    **Use when:**
    - 10+ microservices
    - Need consistent security policies
    - Multiple languages/frameworks
    - Complex traffic patterns
    
    **Avoid when:**
    - Small number of services
    - Simple architecture
    - Resource constraints
    - Team unfamiliar with Kubernetes
  </Accordion>
  
  <Accordion title="Q2: Explain the sidecar pattern">
    **Answer:**
    
    The sidecar pattern deploys a helper container alongside the main application container in the same pod:
    
    ```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pod â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  App   â”‚â—€â–¶â”‚ Sidecar â”‚  â”‚
    â”‚  â”‚        â”‚  â”‚ (Envoy) â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ```
    
    **Benefits:**
    - App doesn't need networking code
    - Language agnostic
    - Updated independently
    - Consistent behavior
    
    **Drawbacks:**
    - Latency overhead (1-3ms)
    - Resource consumption
    - Complexity
  </Accordion>
  
  <Accordion title="Q3: How does mTLS work in a service mesh?">
    **Answer:**
    
    1. **Certificate Authority (CA)** generates root certificate
    2. Each service gets **unique certificate** (SPIFFE identity)
    3. Sidecars **automatically** handle TLS handshake
    4. Both client and server **verify** each other's certificates
    
    ```
    Service A â”€â”€â”€â”€â”€â”€[mTLS]â”€â”€â”€â”€â”€â”€ Service B
        â”‚                           â”‚
        â”œâ”€ Client Certificate       â”œâ”€ Server Certificate
        â””â”€ Verify Server Cert       â””â”€ Verify Client Cert
    ```
    
    **Benefits:**
    - Zero code changes
    - Automatic rotation
    - Service identity verification
    - Encrypted in transit
  </Accordion>
  
  <Accordion title="Q4: How do you implement canary deployments with Istio?">
    **Answer:**
    
    1. Deploy new version alongside old
    2. Create VirtualService with weight-based routing
    3. Gradually shift traffic (10% â†’ 25% â†’ 50% â†’ 100%)
    4. Monitor error rates at each step
    5. Rollback if issues detected
    
    ```yaml
    spec:
      http:
      - route:
        - destination:
            host: my-service
            subset: v1
          weight: 90
        - destination:
            host: my-service
            subset: v2
          weight: 10
    ```
    
    **Key metrics to watch:**
    - Error rates (5xx responses)
    - Latency percentiles
    - Business metrics
  </Accordion>
  
  <Accordion title="Q5: What's the difference between Istio and Linkerd?">
    **Answer:**
    
    | Aspect | Istio | Linkerd |
    |--------|-------|---------|
    | **Complexity** | High | Low |
    | **Resource usage** | Higher | Lower |
    | **Latency** | ~2-3ms | ~1ms |
    | **Features** | Extensive | Focused |
    | **Proxy** | Envoy (C++) | Rust-based |
    
    **Choose Istio**: Complex requirements, multi-cluster, extensive customization
    **Choose Linkerd**: Simplicity, Kubernetes-only, resource constraints
  </Accordion>
</AccordionGroup>

---

## Best Practices

<CardGroup cols={2}>
  <Card title="Start Simple" icon="seedling">
    Begin with basic features (mTLS, observability), add complexity gradually
  </Card>
  <Card title="Test Thoroughly" icon="flask">
    Service mesh adds latency - load test before production
  </Card>
  <Card title="Monitor Resources" icon="gauge">
    Sidecar proxies consume CPU/memory - size appropriately
  </Card>
  <Card title="Plan for Failures" icon="shield">
    Service mesh itself can fail - have runbooks ready
  </Card>
</CardGroup>

---

## Chapter Summary

<Info>
**Key Takeaways:**
- Service mesh moves networking from app code to infrastructure
- Istio provides advanced traffic management and security
- mTLS ensures encrypted, authenticated service communication
- Canary deployments enable safe progressive rollouts
- Choose between Istio and Linkerd based on complexity needs
</Info>

**Next Chapter:** Configuration Management - Centralized configuration for microservices.
