---
title: "AWS Step Functions"
description: "Master serverless workflow orchestration with state machines"
icon: "diagram-project"
---

<Frame>
  <img src="/images/aws/step-functions-architecture.svg" alt="Step Functions Architecture" />
</Frame>

## Module Overview

<Info>
**Estimated Time**: 4-5 hours | **Difficulty**: Intermediate | **Prerequisites**: Lambda
</Info>

AWS Step Functions lets you coordinate multiple AWS services into serverless workflows using visual state machines. This module covers workflow design patterns, error handling, and production best practices.

**What You'll Learn:**
- State machine concepts and design
- State types (Task, Choice, Parallel, Map)
- Error handling and retries
- Standard vs Express workflows
- Service integrations
- Workflow patterns for common use cases

---

## Why Step Functions?

<CardGroup cols={2}>
  <Card title="Visual Workflows" icon="diagram-project">
    Design and visualize complex business processes as state machines
  </Card>
  <Card title="Built-in Error Handling" icon="shield-check">
    Automatic retries, catch blocks, and compensation logic
  </Card>
  <Card title="200+ Integrations" icon="plug">
    Native integration with Lambda, DynamoDB, SQS, SNS, and more
  </Card>
  <Card title="Audit Trail" icon="clipboard-list">
    Complete execution history for debugging and compliance
  </Card>
</CardGroup>

---

## State Machine Concepts

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    State Machine Components                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   STATE MACHINE                                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚   â€¢ Collection of states that define workflow                          â”‚
â”‚   â€¢ Starts at StartAt state, ends at End state                         â”‚
â”‚   â€¢ Executes synchronously or asynchronously                           â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                                                â”‚    â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚    â”‚
â”‚   â”‚    â”‚  START   â”‚                                               â”‚    â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                               â”‚    â”‚
â”‚   â”‚         â”‚                                                      â”‚    â”‚
â”‚   â”‚         â–¼                                                      â”‚    â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚    â”‚
â”‚   â”‚    â”‚ Validate â”‚ â”€â”€â”€â”€ Task State (Lambda)                      â”‚    â”‚
â”‚   â”‚    â”‚  Input   â”‚                                               â”‚    â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                               â”‚    â”‚
â”‚   â”‚         â”‚                                                      â”‚    â”‚
â”‚   â”‚         â–¼                                                      â”‚    â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚    â”‚
â”‚   â”‚    â”‚  Valid?  â”‚â”€â”€â”€â”€â–ºâ”‚ Reject   â”‚ â”€â”€â”€â”€ Choice State            â”‚    â”‚
â”‚   â”‚    â”‚  (yes)   â”‚ no  â”‚          â”‚                              â”‚    â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚    â”‚
â”‚   â”‚         â”‚ yes                                                  â”‚    â”‚
â”‚   â”‚         â–¼                                                      â”‚    â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚    â”‚
â”‚   â”‚    â”‚ Process  â”‚ â”€â”€â”€â”€ Task State (DynamoDB)                    â”‚    â”‚
â”‚   â”‚    â”‚  Order   â”‚                                               â”‚    â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                               â”‚    â”‚
â”‚   â”‚         â”‚                                                      â”‚    â”‚
â”‚   â”‚         â–¼                                                      â”‚    â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚    â”‚
â”‚   â”‚    â”‚   END    â”‚                                               â”‚    â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚    â”‚
â”‚   â”‚                                                                â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Types

### Task State

Performs work by invoking an AWS service or activity.

```json
{
  "ValidateOrder": {
    "Type": "Task",
    "Resource": "arn:aws:lambda:us-east-1:123456789012:function:validate-order",
    "InputPath": "$.order",
    "ResultPath": "$.validation",
    "OutputPath": "$",
    "TimeoutSeconds": 30,
    "Next": "CheckValidation"
  }
}
```

### Choice State

Branching logic based on input.

```json
{
  "CheckValidation": {
    "Type": "Choice",
    "Choices": [
      {
        "Variable": "$.validation.isValid",
        "BooleanEquals": true,
        "Next": "ProcessPayment"
      },
      {
        "Variable": "$.validation.errorCode",
        "StringEquals": "INSUFFICIENT_STOCK",
        "Next": "NotifyOutOfStock"
      }
    ],
    "Default": "RejectOrder"
  }
}
```

### Parallel State

Execute multiple branches simultaneously.

```json
{
  "ProcessInParallel": {
    "Type": "Parallel",
    "Branches": [
      {
        "StartAt": "SendEmail",
        "States": {
          "SendEmail": {
            "Type": "Task",
            "Resource": "arn:aws:lambda:...:send-email",
            "End": true
          }
        }
      },
      {
        "StartAt": "UpdateInventory",
        "States": {
          "UpdateInventory": {
            "Type": "Task",
            "Resource": "arn:aws:lambda:...:update-inventory",
            "End": true
          }
        }
      }
    ],
    "Next": "FinalizeOrder"
  }
}
```

### Map State

Iterate over an array and process each item.

```json
{
  "ProcessLineItems": {
    "Type": "Map",
    "InputPath": "$.order.items",
    "ItemsPath": "$",
    "MaxConcurrency": 10,
    "Iterator": {
      "StartAt": "ProcessItem",
      "States": {
        "ProcessItem": {
          "Type": "Task",
          "Resource": "arn:aws:lambda:...:process-item",
          "End": true
        }
      }
    },
    "ResultPath": "$.processedItems",
    "Next": "CalculateTotal"
  }
}
```

### Wait State

Pause execution for a specified time.

```json
{
  "WaitForDelivery": {
    "Type": "Wait",
    "Seconds": 3600,
    "Next": "CheckDeliveryStatus"
  },
  "WaitUntilShipDate": {
    "Type": "Wait",
    "TimestampPath": "$.order.shipDate",
    "Next": "StartShipping"
  }
}
```

### Other States

```json
{
  "PassThrough": {
    "Type": "Pass",
    "Result": {"status": "processed"},
    "ResultPath": "$.result",
    "Next": "NextState"
  },
  "OrderFailed": {
    "Type": "Fail",
    "Cause": "Order processing failed",
    "Error": "OrderError"
  },
  "OrderComplete": {
    "Type": "Succeed"
  }
}
```

---

## Input/Output Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Flow Through States                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   State Input (raw)                                                     â”‚
â”‚   {                                                                     â”‚
â”‚     "order": {"id": "123", "items": [...], "total": 99.99},            â”‚
â”‚     "customer": {"id": "C001", "email": "..."}                         â”‚
â”‚   }                                                                     â”‚
â”‚         â”‚                                                               â”‚
â”‚         â”‚ InputPath: "$.order"                                         â”‚
â”‚         â–¼                                                               â”‚
â”‚   Task Input                                                            â”‚
â”‚   {"id": "123", "items": [...], "total": 99.99}                        â”‚
â”‚         â”‚                                                               â”‚
â”‚         â”‚ Lambda executes                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚   Task Result                                                           â”‚
â”‚   {"validation": "success", "discount": 10.00}                         â”‚
â”‚         â”‚                                                               â”‚
â”‚         â”‚ ResultPath: "$.orderValidation"                              â”‚
â”‚         â–¼                                                               â”‚
â”‚   State with Result                                                     â”‚
â”‚   {                                                                     â”‚
â”‚     "order": {"id": "123", "items": [...], "total": 99.99},            â”‚
â”‚     "customer": {"id": "C001", "email": "..."},                        â”‚
â”‚     "orderValidation": {"validation": "success", "discount": 10.00}    â”‚
â”‚   }                                                                     â”‚
â”‚         â”‚                                                               â”‚
â”‚         â”‚ OutputPath: "$"                                              â”‚
â”‚         â–¼                                                               â”‚
â”‚   State Output (passed to next state)                                   â”‚
â”‚   (same as above)                                                       â”‚
â”‚                                                                         â”‚
â”‚   Path Reference:                                                       â”‚
â”‚   InputPath:  What to send to task                                     â”‚
â”‚   ResultPath: Where to put task result (null = discard)                â”‚
â”‚   OutputPath: What to pass to next state                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Intrinsic Functions

```json
{
  "TransformData": {
    "Type": "Pass",
    "Parameters": {
      "orderId.$": "States.UUID()",
      "orderDate.$": "States.Format('Order placed at {}', $$.State.EnteredTime)",
      "itemCount.$": "States.ArrayLength($.items)",
      "fullName.$": "States.Format('{} {}', $.firstName, $.lastName)",
      "items.$": "States.ArrayPartition($.allItems, 10)",
      "jsonString.$": "States.JsonToString($.data)",
      "parsedJson.$": "States.StringToJson($.jsonString)"
    },
    "Next": "ProcessOrder"
  }
}
```

---

## Error Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Error Handling Pattern                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ ProcessPayment                                                 â”‚    â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚   â”‚ â”‚ Lambda: process-payment                                  â”‚   â”‚    â”‚
â”‚   â”‚ â”‚                                                          â”‚   â”‚    â”‚
â”‚   â”‚ â”‚ Retry:                                                   â”‚   â”‚    â”‚
â”‚   â”‚ â”‚ â€¢ 3 attempts                                             â”‚   â”‚    â”‚
â”‚   â”‚ â”‚ â€¢ 1s â†’ 2s â†’ 4s (exponential backoff)                    â”‚   â”‚    â”‚
â”‚   â”‚ â”‚                                                          â”‚   â”‚    â”‚
â”‚   â”‚ â”‚ Catch:                                                   â”‚   â”‚    â”‚
â”‚   â”‚ â”‚ â€¢ PaymentDeclined â†’ HandleDeclined                       â”‚   â”‚    â”‚
â”‚   â”‚ â”‚ â€¢ States.ALL â†’ FallbackHandler                          â”‚   â”‚    â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚   Error Types:                                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚   States.ALL          - Matches any error                              â”‚
â”‚   States.Timeout      - Task timed out                                 â”‚
â”‚   States.TaskFailed   - Lambda execution error                         â”‚
â”‚   States.Permissions  - Permission error                               â”‚
â”‚   Custom.PaymentFailed - Custom error from Lambda                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Retry Configuration

```json
{
  "ProcessPayment": {
    "Type": "Task",
    "Resource": "arn:aws:lambda:...:process-payment",
    "Retry": [
      {
        "ErrorEquals": ["Lambda.ServiceException", "Lambda.TooManyRequestsException"],
        "IntervalSeconds": 1,
        "MaxAttempts": 3,
        "BackoffRate": 2.0,
        "MaxDelaySeconds": 30
      },
      {
        "ErrorEquals": ["States.Timeout"],
        "IntervalSeconds": 5,
        "MaxAttempts": 2,
        "BackoffRate": 1.0
      }
    ],
    "Catch": [
      {
        "ErrorEquals": ["PaymentDeclined"],
        "ResultPath": "$.error",
        "Next": "HandleDeclinedPayment"
      },
      {
        "ErrorEquals": ["States.ALL"],
        "ResultPath": "$.error",
        "Next": "NotifyFailure"
      }
    ],
    "Next": "ConfirmOrder"
  }
}
```

### Lambda Error Throwing

```python
class PaymentDeclinedException(Exception):
    pass

class InsufficientFundsException(Exception):
    pass

def lambda_handler(event, context):
    try:
        result = process_payment(event)
        return result
        
    except CardDeclinedError:
        # Step Functions will catch this
        raise PaymentDeclinedException("Card was declined")
        
    except InsufficientFundsError:
        raise InsufficientFundsException("Insufficient funds in account")
```

---

## Standard vs Express Workflows

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Workflow Type Comparison                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Feature              â”‚ Standard              â”‚ Express               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   Duration             â”‚ Up to 1 year         â”‚ Up to 5 minutes       â”‚
â”‚   Execution History    â”‚ Stored (90 days)     â”‚ CloudWatch Logs only  â”‚
â”‚   Start Rate           â”‚ 2,000/sec            â”‚ 100,000/sec           â”‚
â”‚   Pricing              â”‚ Per state transition â”‚ Per execution + dur.  â”‚
â”‚   Idempotency          â”‚ Exactly-once         â”‚ At-least-once         â”‚
â”‚   Execution Type       â”‚ Async (default)      â”‚ Sync or Async         â”‚
â”‚                                                                         â”‚
â”‚   When to Use Standard:                                                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚   âœ“ Long-running workflows (hours/days)                                â”‚
â”‚   âœ“ Need execution history for audit                                   â”‚
â”‚   âœ“ Require exactly-once semantics                                     â”‚
â”‚   âœ“ Human approval workflows                                           â”‚
â”‚                                                                         â”‚
â”‚   When to Use Express:                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚   âœ“ High-volume, short-duration workflows                              â”‚
â”‚   âœ“ Event processing pipelines                                         â”‚
â”‚   âœ“ API orchestration                                                  â”‚
â”‚   âœ“ Cost-sensitive scenarios                                           â”‚
â”‚                                                                         â”‚
â”‚   Pricing Example (1M executions, 5 state transitions each):          â”‚
â”‚   Standard: 5M transitions Ã— $0.000025 = $125                          â”‚
â”‚   Express:  1M Ã— $1.00/M + duration charges = ~$10-20                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Service Integrations

### Direct Service Integrations

```json
{
  "Comment": "Direct integrations without Lambda",
  "States": {
    "PutItemInDynamoDB": {
      "Type": "Task",
      "Resource": "arn:aws:states:::dynamodb:putItem",
      "Parameters": {
        "TableName": "Orders",
        "Item": {
          "order_id": {"S.$": "$.orderId"},
          "status": {"S": "CREATED"},
          "created_at": {"S.$": "$$.State.EnteredTime"}
        }
      },
      "Next": "SendNotification"
    },
    
    "SendNotification": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sns:publish",
      "Parameters": {
        "TopicArn": "arn:aws:sns:us-east-1:123456789012:order-notifications",
        "Message.$": "States.Format('Order {} created', $.orderId)"
      },
      "Next": "AddToQueue"
    },
    
    "AddToQueue": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sqs:sendMessage",
      "Parameters": {
        "QueueUrl": "https://sqs.us-east-1.amazonaws.com/123456789012/orders",
        "MessageBody.$": "States.JsonToString($.order)"
      },
      "Next": "Done"
    },
    
    "InvokeLambda": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "process-order",
        "Payload.$": "$"
      },
      "Next": "Done"
    },
    
    "StartECSTask": {
      "Type": "Task",
      "Resource": "arn:aws:states:::ecs:runTask.sync",
      "Parameters": {
        "Cluster": "my-cluster",
        "TaskDefinition": "process-batch",
        "LaunchType": "FARGATE"
      },
      "Next": "Done"
    }
  }
}
```

### Wait for Callback Pattern

```json
{
  "WaitForHumanApproval": {
    "Type": "Task",
    "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
    "Parameters": {
      "FunctionName": "send-approval-request",
      "Payload": {
        "orderId.$": "$.orderId",
        "approver": "manager@company.com",
        "taskToken.$": "$$.Task.Token"
      }
    },
    "TimeoutSeconds": 86400,
    "Next": "ProcessApprovedOrder"
  }
}
```

```python
# Lambda that sends approval request
def send_approval_request(event, context):
    task_token = event['taskToken']
    order_id = event['orderId']
    
    # Store token for later callback
    dynamodb.put_item(
        TableName='PendingApprovals',
        Item={
            'order_id': order_id,
            'task_token': task_token,
            'status': 'PENDING'
        }
    )
    
    # Send email with approval link
    ses.send_email(
        To=event['approver'],
        Subject=f'Approval needed for order {order_id}',
        Body=f'Click to approve: https://api.../approve?order={order_id}'
    )

# API endpoint that handles approval
def handle_approval(event, context):
    order_id = event['queryStringParameters']['order_id']
    action = event['queryStringParameters']['action']  # approve/reject
    
    # Get stored token
    item = dynamodb.get_item(
        TableName='PendingApprovals',
        Key={'order_id': order_id}
    )
    task_token = item['Item']['task_token']
    
    # Resume Step Function
    if action == 'approve':
        stepfunctions.send_task_success(
            taskToken=task_token,
            output=json.dumps({'approved': True})
        )
    else:
        stepfunctions.send_task_failure(
            taskToken=task_token,
            error='Rejected',
            cause='Manager rejected the order'
        )
```

---

## Common Workflow Patterns

### Saga Pattern (Distributed Transaction)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Saga Pattern                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Each step has a compensating action for rollback:                    â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚  Reserve  â”‚â”€â”€â”€â–ºâ”‚  Charge   â”‚â”€â”€â”€â–ºâ”‚  Ship     â”‚â”€â”€â”€â–º Success          â”‚
â”‚   â”‚  Stock    â”‚    â”‚  Payment  â”‚    â”‚  Order    â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                â”‚                â”‚                            â”‚
â”‚         â”‚ Fail           â”‚ Fail           â”‚ Fail                       â”‚
â”‚         â–¼                â–¼                â–¼                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚  Cancel   â”‚â—„â”€â”€â”€â”‚  Refund   â”‚â—„â”€â”€â”€â”‚  Cancel   â”‚                      â”‚
â”‚   â”‚  Reserve  â”‚    â”‚  Payment  â”‚    â”‚  Shipment â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```json
{
  "StartAt": "ReserveStock",
  "States": {
    "ReserveStock": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...:reserve-stock",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "OrderFailed"
      }],
      "Next": "ChargePayment"
    },
    "ChargePayment": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...:charge-payment",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "ResultPath": "$.error",
        "Next": "CancelReservation"
      }],
      "Next": "ShipOrder"
    },
    "ShipOrder": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...:ship-order",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "ResultPath": "$.error",
        "Next": "RefundPayment"
      }],
      "Next": "OrderComplete"
    },
    "CancelReservation": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...:cancel-reservation",
      "Next": "OrderFailed"
    },
    "RefundPayment": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...:refund-payment",
      "Next": "CancelReservation"
    },
    "OrderComplete": {
      "Type": "Succeed"
    },
    "OrderFailed": {
      "Type": "Fail",
      "Error": "OrderProcessingFailed",
      "Cause": "Order could not be completed"
    }
  }
}
```

### Fan-Out/Fan-In Pattern

```json
{
  "ProcessAllOrders": {
    "Type": "Map",
    "InputPath": "$.orders",
    "MaxConcurrency": 50,
    "ItemProcessor": {
      "ProcessorConfig": {
        "Mode": "DISTRIBUTED",
        "ExecutionType": "EXPRESS"
      },
      "StartAt": "ProcessOrder",
      "States": {
        "ProcessOrder": {
          "Type": "Task",
          "Resource": "arn:aws:lambda:...:process-order",
          "End": true
        }
      }
    },
    "ResultPath": "$.processedOrders",
    "Next": "AggregateResults"
  }
}
```

---

## Best Practices

<CardGroup cols={2}>
  <Card title="Design for Idempotency" icon="shield-check">
    Tasks may retryâ€”ensure operations are safe to repeat
  </Card>
  <Card title="Use ResultPath Wisely" icon="route">
    Preserve input data while adding task results
  </Card>
  <Card title="Set Timeouts" icon="clock">
    Always set TimeoutSeconds to prevent stuck executions
  </Card>
  <Card title="Use Express for High Volume" icon="bolt">
    Express workflows are much cheaper for short tasks
  </Card>
</CardGroup>

---

## ğŸ¯ Interview Questions

<AccordionGroup>
  <Accordion title="Q1: When to use Step Functions vs SQS + Lambda?">
    **Step Functions:**
    - Complex orchestration with branching
    - Need visibility into workflow state
    - Error handling with retries and fallbacks
    - Long-running workflows
    
    **SQS + Lambda:**
    - Simple event processing
    - High-volume, independent tasks
    - Don't need orchestration
    - Cost-sensitive (cheaper at high scale)
  </Accordion>
  
  <Accordion title="Q2: How to handle long-running operations?">
    **Options:**
    1. **Wait for Task Token**: Pause execution, resume via callback
    2. **Activity Tasks**: Worker polls for tasks, reports completion
    3. **Async Lambda**: Start Lambda, use callback pattern
    
    **Example**: Human approval, external system integration
  </Accordion>
  
  <Accordion title="Q3: Standard vs Express - how to choose?">
    **Use Standard when:**
    - Execution longer than 5 minutes
    - Need execution history for audit
    - Require exactly-once semantics
    
    **Use Express when:**
    - High volume (over 1000/sec)
    - Short duration (under 5 min)
    - Cost-sensitive
    - At-least-once is acceptable
  </Accordion>
</AccordionGroup>

---

## Next Module

<Card title="AWS SAM" icon="box" href="/aws/sam">
  Build serverless applications with SAM
</Card>
