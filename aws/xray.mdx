---
title: "AWS X-Ray"
description: "Master distributed tracing with X-Ray for debugging and performance analysis"
icon: "microscope"
---

<Frame>
  <img src="/images/aws/xray-deep-dive.svg" alt="AWS X-Ray Deep Dive" />
</Frame>

## Module Overview

<Info>
**Estimated Time**: 3-4 hours | **Difficulty**: Intermediate | **Prerequisites**: Lambda, CloudWatch
</Info>

AWS X-Ray helps you analyze and debug distributed applications. This module covers tracing concepts, instrumentation, and production debugging patterns.

**What You'll Learn:**
- X-Ray concepts: traces, segments, subsegments
- Instrumenting Lambda, API Gateway, and SDK calls
- Service maps and analytics
- Annotations and metadata
- Sampling rules
- Integration with CloudWatch and other services

---

## Why X-Ray?

<CardGroup cols={2}>
  <Card title="Visualize Request Flow" icon="diagram-project">
    See how requests traverse your microservices architecture
  </Card>
  <Card title="Find Bottlenecks" icon="gauge-high">
    Identify which service or dependency is causing latency
  </Card>
  <Card title="Debug Errors" icon="bug">
    Trace errors back to their source across services
  </Card>
  <Card title="Analyze Performance" icon="chart-line">
    Understand latency distributions and trends
  </Card>
</CardGroup>

---

## X-Ray Concepts

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    X-Ray Tracing Concepts                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   TRACE                                                                 â”‚
â”‚   â”€â”€â”€â”€â”€                                                                 â”‚
â”‚   A unique ID that follows a request through all services              â”‚
â”‚   Trace ID: 1-581cf771-a006649127e371903a2de979                        â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  API Gateway    Lambda: Order    DynamoDB    Lambda: Payment   â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚   â”‚  â”‚ Segment â”‚â”€â”€â”€â–ºâ”‚  Segment  â”‚â”€â”€â”€â–ºâ”‚Subseg. â”‚  â”‚   Segment    â”‚  â”‚  â”‚
â”‚   â”‚  â”‚  50ms   â”‚    â”‚   200ms   â”‚    â”‚  30ms  â”‚  â”‚    150ms     â”‚  â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚   â”‚                      â”‚                                          â”‚  â”‚
â”‚   â”‚                      â””â”€â”€ Subsegment: SNS Publish (20ms)        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   SEGMENT                                                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚   â€¢ Work done by a single service                                      â”‚
â”‚   â€¢ Contains timing, metadata, annotations                             â”‚
â”‚   â€¢ Auto-created for Lambda, API Gateway, etc.                         â”‚
â”‚                                                                         â”‚
â”‚   SUBSEGMENT                                                            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                            â”‚
â”‚   â€¢ Work done within a segment                                         â”‚
â”‚   â€¢ AWS SDK calls, HTTP calls, custom operations                       â”‚
â”‚   â€¢ You create these in your code                                      â”‚
â”‚                                                                         â”‚
â”‚   ANNOTATION                                                            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                            â”‚
â”‚   â€¢ Key-value pairs for filtering traces                               â”‚
â”‚   â€¢ Indexed and searchable                                             â”‚
â”‚   â€¢ Example: user_id = "user-123"                                      â”‚
â”‚                                                                         â”‚
â”‚   METADATA                                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚   â€¢ Additional data for debugging                                      â”‚
â”‚   â€¢ Not indexed, not searchable                                        â”‚
â”‚   â€¢ Example: full request/response body                                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Service Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    X-Ray Service Map                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Auto-generated visualization of your architecture:                   â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚   â”‚ Clients  â”‚                                                         â”‚
â”‚   â”‚  (web)   â”‚                                                         â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚        â”‚                                                                â”‚
â”‚        â–¼                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚   â”‚   API    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Order        â”‚                               â”‚
â”‚   â”‚ Gateway  â”‚         â”‚  Lambda       â”‚                               â”‚
â”‚   â”‚ 99.8%    â”‚         â”‚  avg: 125ms   â”‚                               â”‚
â”‚   â”‚ 45ms avg â”‚         â”‚  99.5% OK     â”‚                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                â”‚                                        â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                â”‚               â”‚               â”‚                       â”‚
â”‚                â–¼               â–¼               â–¼                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚   DynamoDB    â”‚  â”‚     SNS       â”‚  â”‚   Payment     â”‚             â”‚
â”‚   â”‚   Orders      â”‚  â”‚   Notify      â”‚  â”‚   Lambda      â”‚             â”‚
â”‚   â”‚   avg: 8ms    â”‚  â”‚   avg: 15ms   â”‚  â”‚   avg: 200ms  â”‚             â”‚
â”‚   â”‚   100% OK     â”‚  â”‚   100% OK     â”‚  â”‚   98% OK      â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                 â”‚                       â”‚
â”‚                                                 â–¼                       â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                                    â”‚   Stripe API      â”‚               â”‚
â”‚                                    â”‚   (external)      â”‚               â”‚
â”‚                                    â”‚   avg: 180ms      â”‚               â”‚
â”‚                                    â”‚   97% OK          â”‚               â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                         â”‚
â”‚   Color coding:                                                         â”‚
â”‚   ðŸŸ¢ Green: Healthy (>99% success)                                     â”‚
â”‚   ðŸŸ¡ Yellow: Degraded (95-99%)                                         â”‚
â”‚   ðŸ”´ Red: Error state (<95%)                                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Instrumenting Lambda

### Automatic Instrumentation

```python
# Enable X-Ray in Lambda configuration (or SAM/CDK)
# Lambda automatically creates segment for each invocation

# SAM template example
"""
Resources:
  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      Tracing: Active  # This enables X-Ray
"""

# CDK example
"""
const fn = new lambda.Function(this, 'MyFunction', {
  tracing: lambda.Tracing.ACTIVE,
});
"""
```

### Manual Instrumentation with SDK

```python
from aws_xray_sdk.core import xray_recorder
from aws_xray_sdk.core import patch_all

# Patch all supported libraries (boto3, requests, httplib, etc.)
patch_all()

# Or patch specific libraries
from aws_xray_sdk.core import patch
patch(['boto3', 'requests'])

import boto3
import requests

# boto3 and requests calls are now automatically traced
dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('Orders')

def lambda_handler(event, context):
    order_id = event.get('order_id')
    
    # Add annotation (indexed, searchable)
    xray_recorder.put_annotation('order_id', order_id)
    xray_recorder.put_annotation('user_type', 'premium')
    
    # Add metadata (not indexed, for debugging)
    xray_recorder.put_metadata('event', event)
    
    # DynamoDB call is automatically traced as subsegment
    result = table.get_item(Key={'order_id': order_id})
    
    # External HTTP call is automatically traced
    response = requests.get('https://api.example.com/validate')
    
    return result.get('Item')
```

### Custom Subsegments

```python
from aws_xray_sdk.core import xray_recorder
import time

@xray_recorder.capture('process_order')
def process_order(order: dict):
    """Function decorator creates subsegment automatically."""
    
    # All code here is captured in 'process_order' subsegment
    validate_order(order)
    calculate_total(order)
    
    return order

def complex_operation(data: dict):
    """Manual subsegment for granular tracing."""
    
    # Create custom subsegment
    with xray_recorder.in_subsegment('data_transformation') as subsegment:
        subsegment.put_annotation('data_size', len(data))
        
        # Nested subsegment
        with xray_recorder.in_subsegment('step_1_parse'):
            parsed = parse_data(data)
        
        with xray_recorder.in_subsegment('step_2_transform'):
            transformed = transform_data(parsed)
        
        with xray_recorder.in_subsegment('step_3_validate'):
            validated = validate_data(transformed)
    
    return validated

def async_operation():
    """Capture async work correctly."""
    
    subsegment = xray_recorder.begin_subsegment('async_task')
    try:
        # Your async work
        result = do_async_work()
        subsegment.put_metadata('result', result)
    except Exception as e:
        subsegment.add_exception(e)
        raise
    finally:
        xray_recorder.end_subsegment()
```

---

## Tracing Across Services

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cross-Service Tracing                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Trace ID is passed via HTTP headers:                                 â”‚
â”‚   X-Amzn-Trace-Id: Root=1-5759e988-bd862e3fe1be46a994272793;Sampled=1 â”‚
â”‚                                                                         â”‚
â”‚   Service A (Lambda)                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  # Trace ID automatically passed to downstream                  â”‚  â”‚
â”‚   â”‚  response = requests.post(                                      â”‚  â”‚
â”‚   â”‚      'https://service-b.example.com/api',                       â”‚  â”‚
â”‚   â”‚      json=data                                                   â”‚  â”‚
â”‚   â”‚  )                                                               â”‚  â”‚
â”‚   â”‚  # X-Ray SDK adds trace header automatically (when patched)     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                               â”‚
â”‚                         â”‚ X-Amzn-Trace-Id header                       â”‚
â”‚                         â–¼                                               â”‚
â”‚   Service B (ECS/EC2)                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  from aws_xray_sdk.core import xray_recorder                    â”‚  â”‚
â”‚   â”‚  from aws_xray_sdk.ext.flask.middleware import XRayMiddleware   â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚  app = Flask(__name__)                                          â”‚  â”‚
â”‚   â”‚  XRayMiddleware(app, xray_recorder)  # Auto-extract trace ID    â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚  @app.route('/api', methods=['POST'])                           â”‚  â”‚
â”‚   â”‚  def api():                                                      â”‚  â”‚
â”‚   â”‚      # This segment links to same trace                         â”‚  â”‚
â”‚   â”‚      return process_request(request.json)                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   SQS Integration:                                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚   â€¢ SQS passes trace header in message attribute: AWSTraceHeader       â”‚
â”‚   â€¢ Lambda extracts it automatically                                   â”‚
â”‚   â€¢ For custom consumers, extract and set segment parent               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Sampling Rules

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    X-Ray Sampling                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Why Sample?                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   â€¢ Reduce costs (X-Ray charges per trace)                             â”‚
â”‚   â€¢ Reduce noise in high-volume systems                                â”‚
â”‚   â€¢ Still get statistical significance                                  â”‚
â”‚                                                                         â”‚
â”‚   Default Rule:                                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚   â€¢ First request each second: Always traced (reservoir = 1)          â”‚
â”‚   â€¢ Additional requests: 5% sampled                                    â”‚
â”‚                                                                         â”‚
â”‚   Custom Sampling Rules:                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  {                                                               â”‚  â”‚
â”‚   â”‚    "version": 2,                                                 â”‚  â”‚
â”‚   â”‚    "rules": [                                                    â”‚  â”‚
â”‚   â”‚      {                                                           â”‚  â”‚
â”‚   â”‚        "description": "High priority for errors",                â”‚  â”‚
â”‚   â”‚        "host": "*",                                              â”‚  â”‚
â”‚   â”‚        "http_method": "*",                                       â”‚  â”‚
â”‚   â”‚        "url_path": "*",                                          â”‚  â”‚
â”‚   â”‚        "fixed_target": 10,     # 10 per second                   â”‚  â”‚
â”‚   â”‚        "rate": 1.0,            # 100% of remaining               â”‚  â”‚
â”‚   â”‚        "service_name": "*",                                      â”‚  â”‚
â”‚   â”‚        "service_type": "*",                                      â”‚  â”‚
â”‚   â”‚        "attributes": {                                           â”‚  â”‚
â”‚   â”‚          "http.status_code": "5*"  # Match 5xx errors            â”‚  â”‚
â”‚   â”‚        },                                                        â”‚  â”‚
â”‚   â”‚        "priority": 1                                             â”‚  â”‚
â”‚   â”‚      },                                                          â”‚  â”‚
â”‚   â”‚      {                                                           â”‚  â”‚
â”‚   â”‚        "description": "Low volume for health checks",            â”‚  â”‚
â”‚   â”‚        "host": "*",                                              â”‚  â”‚
â”‚   â”‚        "http_method": "GET",                                     â”‚  â”‚
â”‚   â”‚        "url_path": "/health",                                    â”‚  â”‚
â”‚   â”‚        "fixed_target": 1,                                        â”‚  â”‚
â”‚   â”‚        "rate": 0.01,           # 1%                              â”‚  â”‚
â”‚   â”‚        "priority": 2                                             â”‚  â”‚
â”‚   â”‚      }                                                           â”‚  â”‚
â”‚   â”‚    ],                                                            â”‚  â”‚
â”‚   â”‚    "default": {                                                  â”‚  â”‚
â”‚   â”‚      "fixed_target": 1,                                          â”‚  â”‚
â”‚   â”‚      "rate": 0.05              # 5% default                      â”‚  â”‚
â”‚   â”‚    }                                                             â”‚  â”‚
â”‚   â”‚  }                                                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## X-Ray Analytics

### Filter Expressions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    X-Ray Analytics Queries                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Find traces by:                                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚                                                                         â”‚
â”‚   # By annotation (custom indexed data)                                 â”‚
â”‚   annotation.user_id = "user-123"                                      â”‚
â”‚   annotation.order_id = "ORD-456"                                      â”‚
â”‚                                                                         â”‚
â”‚   # By response time                                                    â”‚
â”‚   responsetime > 5                    # Slower than 5 seconds          â”‚
â”‚   duration > 2 AND duration < 5       # Between 2-5 seconds            â”‚
â”‚                                                                         â”‚
â”‚   # By status                                                           â”‚
â”‚   http.status = 500                                                    â”‚
â”‚   fault = true                        # Any 5xx error                  â”‚
â”‚   error = true                        # Any 4xx error                  â”‚
â”‚   throttle = true                     # 429 errors                     â”‚
â”‚                                                                         â”‚
â”‚   # By service                                                          â”‚
â”‚   service("order-service")                                             â”‚
â”‚   service("payment-lambda") AND fault = true                           â”‚
â”‚                                                                         â”‚
â”‚   # By URL                                                              â”‚
â”‚   http.url CONTAINS "/api/orders"                                      â”‚
â”‚   http.method = "POST"                                                 â”‚
â”‚                                                                         â”‚
â”‚   # Combined queries                                                    â”‚
â”‚   annotation.user_type = "premium" AND responsetime > 1                â”‚
â”‚   service("checkout") AND http.status >= 500                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Trace Analysis

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Trace Timeline View                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Trace ID: 1-5759e988-bd862e3fe1be46a994272793                        â”‚
â”‚   Duration: 342ms | Segments: 5 | Subsegments: 12                      â”‚
â”‚                                                                         â”‚
â”‚   Timeline:                                                             â”‚
â”‚   0ms        100ms       200ms       300ms       400ms                 â”‚
â”‚   â”‚          â”‚           â”‚           â”‚           â”‚                     â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ API Gateway (50ms)  â”‚
â”‚   â”‚                                                                     â”‚
â”‚   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Order Lambda (280ms)    â”‚
â”‚   â”‚ â”‚                                                                   â”‚
â”‚   â”‚ â”‚ â”œâ”€â”€â”€â”€â”¤ DynamoDB GetItem (25ms)                                   â”‚
â”‚   â”‚ â”‚      â”‚                                                            â”‚
â”‚   â”‚ â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Payment Lambda (150ms)             â”‚
â”‚   â”‚ â”‚      â”‚                      â”‚                                     â”‚
â”‚   â”‚ â”‚      â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Stripe API (120ms)                   â”‚
â”‚   â”‚ â”‚      â”‚                                                            â”‚
â”‚   â”‚ â”‚      â”œâ”€â”€â”€â”€â”¤ DynamoDB UpdateItem (20ms)                           â”‚
â”‚   â”‚ â”‚           â”‚                                                       â”‚
â”‚   â”‚ â”‚           â”œâ”€â”€â”¤ SNS Publish (15ms)                                â”‚
â”‚   â”‚                                                                     â”‚
â”‚   Legend:                                                               â”‚
â”‚   â–ˆâ–ˆâ–ˆâ–ˆ In progress                                                      â”‚
â”‚   â–‘â–‘â–‘â–‘ Waiting/Idle                                                     â”‚
â”‚   â–“â–“â–“â–“ Error                                                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Integration Patterns

### Lambda with X-Ray Powertools

```python
from aws_lambda_powertools import Logger, Tracer, Metrics
from aws_lambda_powertools.utilities.typing import LambdaContext

logger = Logger(service="order-service")
tracer = Tracer(service="order-service")
metrics = Metrics(service="order-service")

@tracer.capture_method
def get_order(order_id: str) -> dict:
    """Method automatically traced as subsegment."""
    
    # Add annotation for filtering
    tracer.put_annotation(key="order_id", value=order_id)
    
    # Get from DynamoDB (auto-traced if boto3 patched)
    response = table.get_item(Key={'order_id': order_id})
    
    return response.get('Item')

@tracer.capture_method
def process_payment(order: dict) -> dict:
    """Payment processing with detailed tracing."""
    
    tracer.put_metadata(key="order_amount", value=order['amount'])
    
    # External call traced
    result = payment_client.charge(
        amount=order['amount'],
        customer=order['customer_id']
    )
    
    tracer.put_annotation(key="payment_status", value=result['status'])
    
    return result

@logger.inject_lambda_context
@tracer.capture_lambda_handler
@metrics.log_metrics
def lambda_handler(event: dict, context: LambdaContext) -> dict:
    """Main handler with full observability stack."""
    
    order_id = event['pathParameters']['order_id']
    
    order = get_order(order_id)
    payment = process_payment(order)
    
    return {
        'statusCode': 200,
        'body': json.dumps({'order': order, 'payment': payment})
    }
```

### API Gateway Integration

```yaml
# SAM template
Resources:
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      TracingEnabled: true  # Enable X-Ray on API Gateway
      
  OrderFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      Tracing: Active  # Enable X-Ray on Lambda
      Events:
        GetOrder:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /orders/{id}
            Method: get
```

### ECS/Fargate Integration

```python
# Dockerfile
"""
FROM python:3.11-slim

# Install X-Ray daemon (sidecar)
RUN apt-get update && apt-get install -y curl unzip
RUN curl -o daemon.zip https://s3.us-east-2.amazonaws.com/aws-xray-assets.us-east-2/xray-daemon/aws-xray-daemon-linux-3.x.zip
RUN unzip daemon.zip && mv xray /usr/local/bin/

COPY . /app
WORKDIR /app
RUN pip install -r requirements.txt

CMD ["python", "app.py"]
"""

# Flask application with X-Ray
from flask import Flask, request
from aws_xray_sdk.core import xray_recorder, patch_all
from aws_xray_sdk.ext.flask.middleware import XRayMiddleware

patch_all()

app = Flask(__name__)

# Configure X-Ray for non-Lambda environment
xray_recorder.configure(
    service='order-service',
    daemon_address='127.0.0.1:2000',  # Local daemon
    context_missing='LOG_ERROR'
)

XRayMiddleware(app, xray_recorder)

@app.route('/orders/<order_id>')
def get_order(order_id):
    # Request automatically traced
    order = fetch_order(order_id)
    return jsonify(order)
```

---

## Debugging with X-Ray

### Common Patterns

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Debugging Patterns                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   1. Finding the Slow Service                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   Query: responsetime > 2                                              â”‚
â”‚   Look at: Timeline view to see which segment is slowest               â”‚
â”‚                                                                         â”‚
â”‚   2. Tracking Down Errors                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚   Query: fault = true AND annotation.order_id = "ORD-123"              â”‚
â”‚   Look at: Exception details in segment                                â”‚
â”‚                                                                         â”‚
â”‚   3. Correlating with CloudWatch Logs                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚   â€¢ X-Ray trace ID is in Lambda REPORT log                             â”‚
â”‚   â€¢ Search logs by trace ID for full context                           â”‚
â”‚   â€¢ Use CloudWatch ServiceLens for unified view                        â”‚
â”‚                                                                         â”‚
â”‚   4. Identifying Cold Starts                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚   Query: service("my-lambda") AND annotation.cold_start = true         â”‚
â”‚   (Requires adding annotation in init code)                            â”‚
â”‚                                                                         â”‚
â”‚   5. Upstream Dependency Analysis                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚   â€¢ Look at external service subsegments                               â”‚
â”‚   â€¢ Check for timeouts, errors, slow response times                    â”‚
â”‚   â€¢ Stripe API taking 3s? That's your bottleneck!                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Best Practices

<CardGroup cols={2}>
  <Card title="Use Annotations Wisely" icon="tags">
    Add business context (user_id, order_id) for easy filtering
  </Card>
  <Card title="Configure Sampling" icon="filter">
    100% tracing is expensiveâ€”sample based on importance
  </Card>
  <Card title="Trace Errors at 100%" icon="bug">
    Never sample errorsâ€”always trace failures
  </Card>
  <Card title="Set Meaningful Names" icon="font">
    Name subsegments clearly for easy timeline reading
  </Card>
</CardGroup>

### Production Checklist

```python
xray_checklist = {
    "instrumentation": [
        "âœ“ Enable X-Ray on Lambda (Tracing: Active)",
        "âœ“ Enable X-Ray on API Gateway",
        "âœ“ Patch AWS SDK and HTTP clients",
        "âœ“ Add annotations for business context",
        "âœ“ Create subsegments for key operations",
    ],
    "sampling": [
        "âœ“ Configure custom sampling rules",
        "âœ“ 100% sample errors and slow requests",
        "âœ“ Lower sample rate for health checks",
    ],
    "analysis": [
        "âœ“ Set up ServiceLens dashboards",
        "âœ“ Create CloudWatch alarms on X-Ray metrics",
        "âœ“ Document common filter expressions",
    ],
    "cost": [
        "âœ“ Estimate trace volume and costs",
        "âœ“ Adjust sampling to budget",
        "âœ“ Monitor X-Ray costs in Cost Explorer",
    ]
}
```

---

## ðŸŽ¯ Interview Questions

<AccordionGroup>
  <Accordion title="Q1: X-Ray vs CloudWatch Logs vs CloudTrail?">
    **X-Ray:**
    - Distributed tracing
    - Request flow across services
    - Performance and latency analysis
    
    **CloudWatch Logs:**
    - Application logs (what your code outputs)
    - Debugging with log messages
    - Metric extraction from logs
    
    **CloudTrail:**
    - AWS API call history
    - Security auditing (who did what)
    - Compliance and governance
  </Accordion>
  
  <Accordion title="Q2: How does trace propagation work?">
    **Mechanism:**
    - Trace ID passed via `X-Amzn-Trace-Id` HTTP header
    - For SQS: `AWSTraceHeader` message attribute
    - SDK automatically propagates when patched
    
    **Format:**
    ```
    Root=1-5759e988-bd862e3fe1be46a994272793;Parent=53995c3f42cd8ad8;Sampled=1
    ```
    
    - Root: Trace ID
    - Parent: Parent segment ID
    - Sampled: Whether to trace (1=yes, 0=no)
  </Accordion>
  
  <Accordion title="Q3: What's the difference between segments and subsegments?">
    **Segments:**
    - Represent a service/compute unit
    - Created automatically (Lambda, API Gateway)
    - Top-level work unit in a trace
    
    **Subsegments:**
    - Work done within a segment
    - You create these (SDK calls, custom operations)
    - Nested, can have parent subsegments
    - Example: DynamoDB call within Lambda
  </Accordion>
  
  <Accordion title="Q4: How to reduce X-Ray costs?">
    **Strategies:**
    1. **Sampling rules**: Don't trace everything
       - 100% for errors
       - 5-10% for normal requests
       - 1% for health checks
    
    2. **Filter trace types**:
       - Skip tracing for certain paths
       - Higher rates for production, lower for dev
    
    3. **Optimize subsegments**:
       - Don't create too many nested subsegments
       - Use meaningful grouping
  </Accordion>
</AccordionGroup>

---

## Next Module

<Card title="AWS Step Functions" icon="diagram-project" href="/aws/step-functions">
  Orchestrate serverless workflows with state machines
</Card>
