---
title: "Observability & Monitoring"
description: "Master CloudWatch, X-Ray, CloudTrail, and AWS monitoring best practices"
icon: "chart-line"
---

<Frame>
  <img src="/images/aws/cloudwatch-observability.svg" alt="AWS Observability Stack" />
</Frame>

## Module Overview

<Info>
**Estimated Time**: 3-4 hours | **Difficulty**: Intermediate | **Prerequisites**: Core Concepts, Compute
</Info>

Observability is critical for running production workloads. This module covers the complete AWS monitoring stack for logs, metrics, traces, and alerts.

**What You'll Learn:**
- CloudWatch metrics, logs, and alarms
- X-Ray distributed tracing
- CloudTrail for audit logging
- EventBridge for event-driven automation
- Building observability dashboards
- Alerting and incident response

---

## Observability Pillars

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Three Pillars of Observability                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚     METRICS     â”‚  â”‚      LOGS       â”‚  â”‚     TRACES      â”‚        â”‚
â”‚   â”‚   (CloudWatch)  â”‚  â”‚  (CloudWatch    â”‚  â”‚    (X-Ray)      â”‚        â”‚
â”‚   â”‚                 â”‚  â”‚     Logs)       â”‚  â”‚                 â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚            â”‚                    â”‚                    â”‚                  â”‚
â”‚   What happened?       Why did it         Where did it                 â”‚
â”‚   (CPU 85%)            happen?            happen?                      â”‚
â”‚                        (error logs)       (service Aâ†’Bâ†’C)              â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    AWS Observability Stack                       â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   CloudWatch     CloudWatch     X-Ray        CloudTrail         â”‚  â”‚
â”‚   â”‚   Metrics        Logs           Traces       Audit Logs         â”‚  â”‚
â”‚   â”‚      â”‚              â”‚              â”‚              â”‚              â”‚  â”‚
â”‚   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚   â”‚                            â”‚                                     â”‚  â”‚
â”‚   â”‚                    CloudWatch Dashboards                         â”‚  â”‚
â”‚   â”‚                    CloudWatch Alarms                             â”‚  â”‚
â”‚   â”‚                    EventBridge Automation                        â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CloudWatch Metrics

Collect and track metrics from AWS services and custom applications.

### Built-in vs Custom Metrics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CloudWatch Metrics Types                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   BUILT-IN METRICS (Free - Basic Monitoring)                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
â”‚   EC2:        CPUUtilization, NetworkIn/Out, DiskRead/Write            â”‚
â”‚   RDS:        CPUUtilization, FreeableMemory, ReadIOPS, WriteIOPS      â”‚
â”‚   Lambda:     Invocations, Duration, Errors, Throttles, ConcurrentExec â”‚
â”‚   ALB:        RequestCount, TargetResponseTime, HTTPCode_Target_2XX    â”‚
â”‚   DynamoDB:   ConsumedRCU, ConsumedWCU, ThrottledRequests              â”‚
â”‚   S3:         BucketSizeBytes, NumberOfObjects                         â”‚
â”‚                                                                         â”‚
â”‚   Resolution: 5 minutes (basic), 1 minute (detailed - extra cost)      â”‚
â”‚                                                                         â”‚
â”‚   CUSTOM METRICS (You publish)                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   â€¢ Application-specific metrics                                       â”‚
â”‚   â€¢ Business KPIs (orders/min, signups/hour)                          â”‚
â”‚   â€¢ Memory utilization (not built-in for EC2!)                        â”‚
â”‚   â€¢ Queue depth, cache hit ratio                                       â”‚
â”‚                                                                         â”‚
â”‚   Resolution: 1 second to 1 minute (high-resolution)                   â”‚
â”‚   Cost: $0.30 per metric per month                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Publishing Custom Metrics

```python
import boto3
from datetime import datetime

cloudwatch = boto3.client('cloudwatch')

def publish_custom_metric(namespace: str, metric_name: str, 
                          value: float, unit: str = 'Count',
                          dimensions: list = None):
    """Publish custom metric to CloudWatch."""
    
    metric_data = {
        'MetricName': metric_name,
        'Value': value,
        'Unit': unit,
        'Timestamp': datetime.utcnow(),
    }
    
    if dimensions:
        metric_data['Dimensions'] = dimensions
    
    cloudwatch.put_metric_data(
        Namespace=namespace,
        MetricData=[metric_data]
    )

# Example: Track orders per minute
publish_custom_metric(
    namespace='MyApp/Ecommerce',
    metric_name='OrdersPlaced',
    value=42,
    unit='Count',
    dimensions=[
        {'Name': 'Environment', 'Value': 'Production'},
        {'Name': 'Region', 'Value': 'us-east-1'}
    ]
)

# Example: Track memory utilization (not built-in!)
import psutil

publish_custom_metric(
    namespace='MyApp/System',
    metric_name='MemoryUtilization',
    value=psutil.virtual_memory().percent,
    unit='Percent',
    dimensions=[
        {'Name': 'InstanceId', 'Value': 'i-1234567890abcdef0'}
    ]
)

# High-resolution metrics (1-second granularity)
cloudwatch.put_metric_data(
    Namespace='MyApp/HighFrequency',
    MetricData=[{
        'MetricName': 'TransactionsPerSecond',
        'Value': 1500,
        'Unit': 'Count/Second',
        'StorageResolution': 1  # 1 = high-res, 60 = standard
    }]
)
```

### CloudWatch Embedded Metric Format (EMF)

```python
import json

def emit_emf_metric(metric_name: str, value: float, dimensions: dict):
    """
    Embedded Metric Format - publish metrics via logs.
    Automatically extracted by CloudWatch.
    """
    emf_log = {
        "_aws": {
            "Timestamp": int(datetime.utcnow().timestamp() * 1000),
            "CloudWatchMetrics": [{
                "Namespace": "MyApp",
                "Dimensions": [list(dimensions.keys())],
                "Metrics": [{
                    "Name": metric_name,
                    "Unit": "Count"
                }]
            }]
        },
        metric_name: value,
        **dimensions
    }
    
    # Print to stdout - CloudWatch Logs extracts the metric
    print(json.dumps(emf_log))

# Usage in Lambda
emit_emf_metric(
    metric_name="OrderValue",
    value=99.99,
    dimensions={"Service": "Checkout", "Environment": "prod"}
)
```

---

## CloudWatch Logs

Centralized log management for all AWS services and applications.

### Log Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CloudWatch Logs Structure                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   LOG GROUP: /aws/lambda/my-function                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€ LOG STREAM: 2024/01/15/[$LATEST]abc123                       â”‚
â”‚       â”‚       â”‚                                                         â”‚
â”‚       â”‚       â”œâ”€â”€ Log Event: {"level": "INFO", "msg": "Started"}       â”‚
â”‚       â”‚       â”œâ”€â”€ Log Event: {"level": "ERROR", "msg": "Failed"}       â”‚
â”‚       â”‚       â””â”€â”€ Log Event: {"level": "INFO", "msg": "Completed"}     â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€ LOG STREAM: 2024/01/15/[$LATEST]def456                       â”‚
â”‚       â”‚       â””â”€â”€ ...                                                   â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â””â”€â”€ LOG STREAM: 2024/01/16/[$LATEST]ghi789                       â”‚
â”‚               â””â”€â”€ ...                                                   â”‚
â”‚                                                                         â”‚
â”‚   RETENTION SETTINGS:                                                  â”‚
â”‚   â€¢ 1 day to 10 years (or never expire)                                â”‚
â”‚   â€¢ Export to S3 for long-term storage                                 â”‚
â”‚   â€¢ Stream to Kinesis/Lambda for real-time processing                  â”‚
â”‚                                                                         â”‚
â”‚   PRICING:                                                              â”‚
â”‚   â€¢ Ingestion: $0.50 per GB                                            â”‚
â”‚   â€¢ Storage: $0.03 per GB/month                                        â”‚
â”‚   â€¢ Queries (Logs Insights): $0.005 per GB scanned                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Structured Logging Best Practices

```python
import json
import logging
from datetime import datetime

class StructuredLogger:
    """JSON structured logger for CloudWatch Logs."""
    
    def __init__(self, service_name: str):
        self.service_name = service_name
        self.logger = logging.getLogger()
        self.logger.setLevel(logging.INFO)
    
    def _format_log(self, level: str, message: str, **kwargs) -> str:
        log_entry = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": level,
            "service": self.service_name,
            "message": message,
            **kwargs
        }
        return json.dumps(log_entry)
    
    def info(self, message: str, **kwargs):
        print(self._format_log("INFO", message, **kwargs))
    
    def error(self, message: str, **kwargs):
        print(self._format_log("ERROR", message, **kwargs))
    
    def warn(self, message: str, **kwargs):
        print(self._format_log("WARN", message, **kwargs))

# Usage
logger = StructuredLogger("order-service")

def process_order(order_id: str, user_id: str):
    logger.info(
        "Processing order",
        order_id=order_id,
        user_id=user_id,
        action="process_order"
    )
    
    try:
        # Process order...
        logger.info(
            "Order completed",
            order_id=order_id,
            duration_ms=150,
            action="order_complete"
        )
    except Exception as e:
        logger.error(
            "Order failed",
            order_id=order_id,
            error=str(e),
            action="order_failed"
        )
        raise
```

### CloudWatch Logs Insights

```sql
-- Find all errors in the last hour
fields @timestamp, @message
| filter @message like /ERROR/
| sort @timestamp desc
| limit 100

-- Parse JSON logs and aggregate
fields @timestamp, @message
| parse @message '{"level":"*","service":"*","message":"*"' as level, service, msg
| filter level = "ERROR"
| stats count(*) as error_count by service
| sort error_count desc

-- Calculate p99 latency from Lambda
fields @timestamp, @duration
| filter @type = "REPORT"
| stats avg(@duration) as avg_duration,
        pct(@duration, 50) as p50,
        pct(@duration, 95) as p95,
        pct(@duration, 99) as p99
  by bin(1h)

-- Find slow API requests
fields @timestamp, @message
| parse @message '"duration_ms":*,' as duration
| filter duration > 1000
| sort duration desc
| limit 50

-- Error rate over time
fields @timestamp, @message
| filter @message like /level/
| parse @message '"level":"*"' as level
| stats count(*) as total,
        sum(level = "ERROR") as errors
  by bin(5m)
| display errors / total * 100 as error_rate
```

---

## X-Ray Distributed Tracing

Trace requests across microservices to identify bottlenecks and errors.

### X-Ray Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    X-Ray Distributed Tracing                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Request Flow with Trace:                                             â”‚
â”‚                                                                         â”‚
â”‚   Client                                                                â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â”‚  Trace ID: 1-abc123-def456789                                    â”‚
â”‚     â–¼                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  API Gateway                                                     â”‚  â”‚
â”‚   â”‚  Segment: 50ms                                                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                         â”‚
â”‚                               â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Lambda: Order Service                                           â”‚  â”‚
â”‚   â”‚  Segment: 200ms                                                  â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ Subsegment: DynamoDB Query (30ms)                          â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ Subsegment: External API Call (100ms)                      â”‚  â”‚
â”‚   â”‚  â””â”€â”€ Subsegment: SNS Publish (20ms)                             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â–¼                                 â–¼                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  Lambda: Inventory   â”‚        â”‚  Lambda: Payment      â”‚            â”‚
â”‚   â”‚  Segment: 80ms       â”‚        â”‚  Segment: 150ms       â”‚            â”‚
â”‚   â”‚  â””â”€â”€ DynamoDB (50ms) â”‚        â”‚  â””â”€â”€ Stripe API (120ms)â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                         â”‚
â”‚   Service Map (auto-generated):                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚   API    â”‚â”€â”€â”€â–ºâ”‚  Order   â”‚â”€â”€â”€â–ºâ”‚ Inventoryâ”‚â”€â”€â”€â–ºâ”‚ DynamoDB â”‚        â”‚
â”‚   â”‚ Gateway  â”‚    â”‚ Service  â”‚    â”‚ Service  â”‚    â”‚          â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                        â”‚                                                â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                                    â”‚ Payment  â”‚                        â”‚
â”‚                                    â”‚ Service  â”‚                        â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Instrumenting Lambda with X-Ray

```python
import boto3
from aws_xray_sdk.core import xray_recorder
from aws_xray_sdk.core import patch_all

# Patch all supported libraries (boto3, requests, etc.)
patch_all()

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('orders')

@xray_recorder.capture('process_order')
def process_order(order_id: str):
    """Process order with X-Ray tracing."""
    
    # Add annotation (indexed, searchable)
    xray_recorder.put_annotation('order_id', order_id)
    
    # Add metadata (not indexed, for debugging)
    xray_recorder.put_metadata('order_details', {
        'order_id': order_id,
        'timestamp': '2024-01-15T10:00:00Z'
    })
    
    # Subsegment for custom operation
    with xray_recorder.in_subsegment('validate_order') as subsegment:
        subsegment.put_annotation('validation_type', 'full')
        validate_order(order_id)
    
    # DynamoDB call is automatically traced
    result = table.get_item(Key={'order_id': order_id})
    
    # External API call with custom subsegment
    with xray_recorder.in_subsegment('external_api') as subsegment:
        subsegment.put_metadata('api', 'payment_gateway')
        response = call_payment_api(result['Item'])
    
    return response

def lambda_handler(event, context):
    order_id = event.get('order_id')
    return process_order(order_id)
```

---

## CloudWatch Alarms

Automated alerts and actions based on metric thresholds.

### Alarm Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CloudWatch Alarm States                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Alarm States:                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚   â”‚    â”‚    OK    â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚ ALARM    â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚INSUFFICIENTâ”‚       â”‚  â”‚
â”‚   â”‚    â”‚  (green) â”‚        â”‚  (red)   â”‚        â”‚   DATA     â”‚       â”‚  â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   Alarm Components:                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   METRIC           STATISTIC       PERIOD      THRESHOLD        â”‚  â”‚
â”‚   â”‚   CPUUtilization   Average         5 minutes   > 80%            â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   EVALUATION PERIODS: 3                                         â”‚  â”‚
â”‚   â”‚   (3 consecutive 5-min periods above 80% = ALARM)               â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   Alarm Actions:                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   â€¢ SNS Topic (email, SMS, Lambda)                              â”‚  â”‚
â”‚   â”‚   â€¢ Auto Scaling (scale up/down)                                â”‚  â”‚
â”‚   â”‚   â€¢ EC2 Actions (stop, terminate, reboot)                       â”‚  â”‚
â”‚   â”‚   â€¢ Systems Manager (run automation)                            â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Essential Alarms (Terraform)

```hcl
# High CPU Alarm
resource "aws_cloudwatch_metric_alarm" "high_cpu" {
  alarm_name          = "high-cpu-utilization"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 3
  metric_name         = "CPUUtilization"
  namespace           = "AWS/EC2"
  period              = 300  # 5 minutes
  statistic           = "Average"
  threshold           = 80
  alarm_description   = "CPU utilization exceeds 80%"
  
  dimensions = {
    AutoScalingGroupName = aws_autoscaling_group.web.name
  }
  
  alarm_actions = [
    aws_sns_topic.alerts.arn,
    aws_autoscaling_policy.scale_up.arn
  ]
  
  ok_actions = [aws_sns_topic.alerts.arn]
}

# Lambda Error Rate Alarm
resource "aws_cloudwatch_metric_alarm" "lambda_errors" {
  alarm_name          = "lambda-high-error-rate"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 2
  threshold           = 5  # 5% error rate
  alarm_description   = "Lambda error rate exceeds 5%"
  
  metric_query {
    id          = "error_rate"
    expression  = "(errors / invocations) * 100"
    label       = "Error Rate"
    return_data = true
  }
  
  metric_query {
    id = "errors"
    metric {
      metric_name = "Errors"
      namespace   = "AWS/Lambda"
      period      = 300
      stat        = "Sum"
      dimensions  = { FunctionName = "my-function" }
    }
  }
  
  metric_query {
    id = "invocations"
    metric {
      metric_name = "Invocations"
      namespace   = "AWS/Lambda"
      period      = 300
      stat        = "Sum"
      dimensions  = { FunctionName = "my-function" }
    }
  }
  
  alarm_actions = [aws_sns_topic.alerts.arn]
}

# DynamoDB Throttling Alarm
resource "aws_cloudwatch_metric_alarm" "dynamodb_throttle" {
  alarm_name          = "dynamodb-throttling"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "ThrottledRequests"
  namespace           = "AWS/DynamoDB"
  period              = 60
  statistic           = "Sum"
  threshold           = 0
  
  dimensions = {
    TableName = "my-table"
  }
  
  alarm_actions = [aws_sns_topic.alerts.arn]
}

# Composite Alarm (multiple conditions)
resource "aws_cloudwatch_composite_alarm" "critical" {
  alarm_name = "critical-system-alarm"
  
  alarm_rule = "ALARM(${aws_cloudwatch_metric_alarm.high_cpu.alarm_name}) AND ALARM(${aws_cloudwatch_metric_alarm.lambda_errors.alarm_name})"
  
  alarm_actions = [aws_sns_topic.pagerduty.arn]
}
```

---

## CloudTrail (Audit Logging)

Track all API calls for security and compliance.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CloudTrail Architecture                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Every AWS API Call:                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   User/Role â”€â”€â”€â–º AWS API â”€â”€â”€â–º CloudTrail â”€â”€â”€â–º S3 Bucket         â”‚  â”‚
â”‚   â”‚                                    â”‚                             â”‚  â”‚
â”‚   â”‚                                    â””â”€â”€â–º CloudWatch Logs          â”‚  â”‚
â”‚   â”‚                                    â””â”€â”€â–º EventBridge (real-time)  â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   Event Types:                                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   â€¢ Management Events: Control plane (CreateBucket, RunInstances)      â”‚
â”‚   â€¢ Data Events: Data plane (S3 GetObject, Lambda Invoke)              â”‚
â”‚   â€¢ Insights Events: Unusual API activity detection                    â”‚
â”‚                                                                         â”‚
â”‚   Sample Event:                                                         â”‚
â”‚   {                                                                     â”‚
â”‚     "eventTime": "2024-01-15T10:30:00Z",                               â”‚
â”‚     "eventSource": "s3.amazonaws.com",                                 â”‚
â”‚     "eventName": "DeleteBucket",                                       â”‚
â”‚     "userIdentity": {                                                   â”‚
â”‚       "type": "IAMUser",                                               â”‚
â”‚       "userName": "admin",                                             â”‚
â”‚       "arn": "arn:aws:iam::123456789012:user/admin"                    â”‚
â”‚     },                                                                  â”‚
â”‚     "sourceIPAddress": "203.0.113.50",                                 â”‚
â”‚     "requestParameters": { "bucketName": "my-bucket" }                 â”‚
â”‚   }                                                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CloudTrail Best Practices

```python
# CloudTrail configuration checklist
cloudtrail_config = {
    "multi_region": True,           # Trail in all regions
    "log_file_validation": True,    # Detect tampering
    "s3_encryption": "SSE-KMS",     # Encrypt logs
    "cloudwatch_logs": True,        # Real-time analysis
    "data_events": {
        "s3": ["arn:aws:s3:::sensitive-bucket/*"],
        "lambda": True
    },
    "insights": True,               # Anomaly detection
    "organization_trail": True      # Multi-account
}

# Real-time alerting with EventBridge
# Detect root user login
eventbridge_rule = {
    "source": ["aws.signin"],
    "detail-type": ["AWS Console Sign In via CloudTrail"],
    "detail": {
        "userIdentity": {
            "type": ["Root"]
        }
    }
}
```

---

## ğŸ¯ Interview Questions

<AccordionGroup>
  <Accordion title="Q1: How would you debug a slow API response?">
    **Systematic approach:**
    
    1. **X-Ray Trace**: Find the specific slow request
       - Identify which service/subsegment is slow
       - Check annotations for context
    
    2. **CloudWatch Metrics**: Check historical patterns
       - Is this a spike or gradual increase?
       - Correlate with CPU, memory, connections
    
    3. **CloudWatch Logs**: Find related errors
       ```sql
       fields @timestamp, @message
       | filter trace_id = "1-abc123..."
       | sort @timestamp
       ```
    
    4. **Service-specific checks**:
       - Lambda: Cold starts? Memory sufficient?
       - DynamoDB: Throttling? Hot partition?
       - RDS: Connection pool exhausted?
  </Accordion>
  
  <Accordion title="Q2: What metrics should you monitor for a web application?">
    **Essential metrics by layer:**
    
    **Load Balancer:**
    - RequestCount, TargetResponseTime
    - HTTPCode_Target_5XX, HTTPCode_ELB_5XX
    - HealthyHostCount, UnhealthyHostCount
    
    **Compute (EC2/Lambda):**
    - CPUUtilization, MemoryUtilization (custom)
    - Lambda: Duration, Errors, Throttles
    
    **Database:**
    - CPUUtilization, FreeableMemory
    - DatabaseConnections, ReadIOPS, WriteIOPS
    - DynamoDB: ThrottledRequests
    
    **Application:**
    - Error rate, Latency (p50, p95, p99)
    - Requests per second
    - Business metrics (orders, signups)
  </Accordion>
  
  <Accordion title="Q3: How do you reduce CloudWatch Logs costs?">
    **Cost optimization strategies:**
    
    1. **Reduce ingestion**:
       - Filter logs at source (log level INFO not DEBUG)
       - Use sampling for high-volume logs
    
    2. **Optimize retention**:
       - Set appropriate retention (7-30 days for most)
       - Export to S3 for long-term (cheaper)
    
    3. **Use Logs Insights efficiently**:
       - Narrow time ranges
       - Use specific log groups
       - Cache common queries
    
    4. **Consider alternatives**:
       - Kinesis Firehose â†’ S3 for high volume
       - OpenSearch for complex analysis
  </Accordion>
  
  <Accordion title="Q4: How do you set up alerting for a production system?">
    **Alert hierarchy:**
    
    1. **Critical (PagerDuty/immediate)**:
       - Service down (health check failures)
       - Error rate > 5%
       - Latency p99 > 5s
       - Security events (root login)
    
    2. **Warning (Slack/email)**:
       - Error rate > 1%
       - CPU > 80% sustained
       - Disk > 85%
       - Approaching quotas
    
    3. **Informational (dashboard)**:
       - Deployment events
       - Scaling events
       - Cost anomalies
    
    **Best practices:**
    - Avoid alert fatigue (tune thresholds)
    - Use composite alarms
    - Include runbook links in alerts
  </Accordion>
  
  <Accordion title="Q5: CloudWatch vs third-party observability tools?">
    **CloudWatch advantages:**
    - Native integration, no agents for AWS services
    - Lower cost for basic use cases
    - No data egress charges
    
    **Third-party advantages (Datadog, New Relic):**
    - Better visualization and correlation
    - APM with code-level insights
    - Multi-cloud support
    - More powerful querying
    
    **Hybrid approach:**
    - Use CloudWatch for AWS metrics/logs
    - Stream to third-party for analysis
    - Keep costs balanced
  </Accordion>
</AccordionGroup>

---

## ğŸ§ª Hands-On Lab: Build Observability Dashboard

<Steps>
  <Step title="Enable X-Ray on Lambda">
    Add X-Ray SDK and enable active tracing
  </Step>
  
  <Step title="Create CloudWatch Dashboard">
    Add widgets for key metrics (CPU, errors, latency)
  </Step>
  
  <Step title="Set Up Structured Logging">
    Implement JSON logging with correlation IDs
  </Step>
  
  <Step title="Create Alarms">
    Set up CPU, error rate, and latency alarms
  </Step>
  
  <Step title="Configure CloudTrail">
    Enable multi-region trail with CloudWatch Logs
  </Step>
</Steps>

---

## Next Module

<Card title="CDN & Edge Services" icon="globe" href="/aws/cdn-edge">
  Master CloudFront, Global Accelerator, and edge computing
</Card>
