---
title: "CDN & Edge Services"
description: "Master CloudFront, Global Accelerator, and edge computing for global performance"
icon: "globe"
---

<Frame>
  <img src="/images/aws/cloudfront-edge.svg" alt="CloudFront and Edge Computing Architecture" />
</Frame>

## Module Overview

<Info>
**Estimated Time**: 3-4 hours | **Difficulty**: Intermediate | **Prerequisites**: Networking, Storage
</Info>

Edge services bring your content and compute closer to users worldwide. This module covers content delivery, global acceleration, and edge computing patterns.

**What You'll Learn:**
- CloudFront CDN configuration and optimization
- Origin types and behaviors
- Cache invalidation strategies
- Lambda@Edge and CloudFront Functions
- Global Accelerator for non-HTTP workloads
- Edge security with WAF and Shield

---

## CloudFront Overview

Amazon CloudFront is a global CDN with 450+ edge locations worldwide.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CloudFront Architecture                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   User in Tokyo                          User in London                 â”‚
â”‚        â”‚                                       â”‚                        â”‚
â”‚        â”‚ 20ms                                  â”‚ 15ms                   â”‚
â”‚        â–¼                                       â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚  Edge: Tokyo â”‚                       â”‚ Edge: London â”‚              â”‚
â”‚   â”‚  (Cache HIT) â”‚                       â”‚ (Cache HIT)  â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                         â”‚
â”‚   Cache MISS? Request goes to Regional Edge Cache, then Origin         â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                     Regional Edge Cache                          â”‚  â”‚
â”‚   â”‚              (Larger cache, fewer locations)                     â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚   â”‚    â”‚ Asia-Pacificâ”‚  â”‚   Europe    â”‚  â”‚  Americas   â”‚           â”‚  â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                         â”‚
â”‚                               â”‚ Cache MISS                              â”‚
â”‚                               â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         ORIGIN                                   â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚   â”‚    â”‚  S3 Bucket  â”‚  â”‚     ALB     â”‚  â”‚   Custom    â”‚           â”‚  â”‚
â”‚   â”‚    â”‚  (static)   â”‚  â”‚   (API)     â”‚  â”‚   Origin    â”‚           â”‚  â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   KEY BENEFITS:                                                        â”‚
â”‚   â€¢ 450+ edge locations globally                                       â”‚
â”‚   â€¢ Sub-50ms latency for cached content                               â”‚
â”‚   â€¢ DDoS protection included                                           â”‚
â”‚   â€¢ Origin protection (reduces load)                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CloudFront Distribution Setup

### Origin Types

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CloudFront Origin Types                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   S3 BUCKET (Static Content)                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   â€¢ Best for: Images, CSS, JS, videos                                  â”‚
â”‚   â€¢ Use Origin Access Control (OAC) - NOT public bucket!              â”‚
â”‚   â€¢ Optionally restrict to CloudFront only                             â”‚
â”‚                                                                         â”‚
â”‚   ALB/ELB (Dynamic Content)                                            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   â€¢ Best for: APIs, dynamic HTML                                       â”‚
â”‚   â€¢ Must be public (or use VPC origins)                                â”‚
â”‚   â€¢ Forward headers, cookies, query strings as needed                  â”‚
â”‚                                                                         â”‚
â”‚   CUSTOM ORIGIN (Any HTTP Server)                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚   â€¢ Best for: On-prem, other clouds                                    â”‚
â”‚   â€¢ Supports HTTP/HTTPS                                                â”‚
â”‚   â€¢ Set timeouts, keep-alive connections                               â”‚
â”‚                                                                         â”‚
â”‚   MEDIA STORE / MEDIA PACKAGE                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   â€¢ Best for: Live/VOD video streaming                                 â”‚
â”‚   â€¢ HLS, DASH, CMAF support                                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CloudFront with Terraform

```hcl
# S3 bucket for static content
resource "aws_s3_bucket" "website" {
  bucket = "my-website-assets-${random_id.suffix.hex}"
}

# Origin Access Control (modern, replaces OAI)
resource "aws_cloudfront_origin_access_control" "website" {
  name                              = "website-oac"
  origin_access_control_origin_type = "s3"
  signing_behavior                  = "always"
  signing_protocol                  = "sigv4"
}

# CloudFront Distribution
resource "aws_cloudfront_distribution" "website" {
  enabled             = true
  is_ipv6_enabled     = true
  default_root_object = "index.html"
  price_class         = "PriceClass_100"  # US, Canada, Europe only
  
  # Aliases (custom domains)
  aliases = ["www.example.com", "example.com"]
  
  # S3 Origin (static content)
  origin {
    domain_name              = aws_s3_bucket.website.bucket_regional_domain_name
    origin_id                = "S3-Website"
    origin_access_control_id = aws_cloudfront_origin_access_control.website.id
  }
  
  # ALB Origin (API)
  origin {
    domain_name = aws_lb.api.dns_name
    origin_id   = "ALB-API"
    
    custom_origin_config {
      http_port              = 80
      https_port             = 443
      origin_protocol_policy = "https-only"
      origin_ssl_protocols   = ["TLSv1.2"]
    }
    
    # Custom headers to verify origin requests
    custom_header {
      name  = "X-Origin-Verify"
      value = var.origin_secret
    }
  }
  
  # Default behavior (static content from S3)
  default_cache_behavior {
    allowed_methods        = ["GET", "HEAD", "OPTIONS"]
    cached_methods         = ["GET", "HEAD"]
    target_origin_id       = "S3-Website"
    viewer_protocol_policy = "redirect-to-https"
    compress               = true
    
    cache_policy_id          = aws_cloudfront_cache_policy.static.id
    origin_request_policy_id = aws_cloudfront_origin_request_policy.cors.id
    
    # Lambda@Edge for SEO/redirects
    lambda_function_association {
      event_type   = "origin-request"
      lambda_arn   = aws_lambda_function.edge_redirect.qualified_arn
      include_body = false
    }
  }
  
  # API behavior (forward to ALB)
  ordered_cache_behavior {
    path_pattern           = "/api/*"
    allowed_methods        = ["DELETE", "GET", "HEAD", "OPTIONS", "PATCH", "POST", "PUT"]
    cached_methods         = ["GET", "HEAD"]
    target_origin_id       = "ALB-API"
    viewer_protocol_policy = "https-only"
    compress               = true
    
    # Don't cache API responses (or use short TTL)
    cache_policy_id          = aws_cloudfront_cache_policy.api.id
    origin_request_policy_id = aws_cloudfront_origin_request_policy.api.id
  }
  
  # SSL Certificate
  viewer_certificate {
    acm_certificate_arn      = aws_acm_certificate.website.arn
    ssl_support_method       = "sni-only"
    minimum_protocol_version = "TLSv1.2_2021"
  }
  
  # Geo restrictions (optional)
  restrictions {
    geo_restriction {
      restriction_type = "none"
    }
  }
  
  # Custom error responses
  custom_error_response {
    error_code            = 404
    response_code         = 200
    response_page_path    = "/index.html"
    error_caching_min_ttl = 300
  }
  
  # WAF integration
  web_acl_id = aws_wafv2_web_acl.cloudfront.arn
  
  tags = {
    Name = "website-distribution"
  }
}

# Cache Policy for Static Content
resource "aws_cloudfront_cache_policy" "static" {
  name        = "static-content"
  min_ttl     = 86400      # 1 day minimum
  default_ttl = 604800     # 7 days default
  max_ttl     = 31536000   # 1 year maximum
  
  parameters_in_cache_key_and_forwarded_to_origin {
    cookies_config {
      cookie_behavior = "none"
    }
    headers_config {
      header_behavior = "none"
    }
    query_strings_config {
      query_string_behavior = "none"
    }
    enable_accept_encoding_brotli = true
    enable_accept_encoding_gzip   = true
  }
}

# Cache Policy for API (short cache or no cache)
resource "aws_cloudfront_cache_policy" "api" {
  name        = "api-cache"
  min_ttl     = 0
  default_ttl = 0    # Don't cache by default
  max_ttl     = 3600 # Honor Cache-Control up to 1 hour
  
  parameters_in_cache_key_and_forwarded_to_origin {
    cookies_config {
      cookie_behavior = "all"
    }
    headers_config {
      header_behavior = "whitelist"
      headers {
        items = ["Authorization", "Accept-Language"]
      }
    }
    query_strings_config {
      query_string_behavior = "all"
    }
  }
}
```

---

## Cache Optimization

### Cache Key Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cache Key Best Practices                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   DEFAULT CACHE KEY: Protocol + Domain + Path                          â”‚
â”‚   Example: https://example.com/images/logo.png                         â”‚
â”‚                                                                         â”‚
â”‚   ADDING TO CACHE KEY (reduces cache hit ratio):                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚   â€¢ Query strings: ?version=2 â†’ Different cache entry                  â”‚
â”‚   â€¢ Headers: Accept-Language â†’ Varies by language                      â”‚
â”‚   â€¢ Cookies: session_id â†’ DON'T (one per user = no caching!)          â”‚
â”‚                                                                         â”‚
â”‚   BEST PRACTICES:                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   STATIC ASSETS (/images/*, /css/*, /js/*)                      â”‚  â”‚
â”‚   â”‚   â€¢ No query strings, headers, or cookies in cache key          â”‚  â”‚
â”‚   â”‚   â€¢ Use versioned URLs: /js/app.v2.3.1.js                       â”‚  â”‚
â”‚   â”‚   â€¢ Long TTL (1 year)                                           â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   API ENDPOINTS (/api/*)                                        â”‚  â”‚
â”‚   â”‚   â€¢ Forward Authorization header                                 â”‚  â”‚
â”‚   â”‚   â€¢ Forward relevant query strings                               â”‚  â”‚
â”‚   â”‚   â€¢ Short or no TTL                                              â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   PERSONALIZED CONTENT                                           â”‚  â”‚
â”‚   â”‚   â€¢ Don't cache (TTL=0)                                          â”‚  â”‚
â”‚   â”‚   â€¢ Or use Lambda@Edge to personalize at edge                   â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cache Invalidation

```python
import boto3

cloudfront = boto3.client('cloudfront')

def invalidate_paths(distribution_id: str, paths: list):
    """
    Invalidate specific paths in CloudFront cache.
    
    Note: First 1,000 invalidation paths/month are free.
    Then $0.005 per path.
    """
    response = cloudfront.create_invalidation(
        DistributionId=distribution_id,
        InvalidationBatch={
            'Paths': {
                'Quantity': len(paths),
                'Items': paths  # e.g., ['/images/*', '/index.html']
            },
            'CallerReference': str(time.time())
        }
    )
    return response['Invalidation']['Id']

# Invalidate specific file
invalidate_paths('E1234567890', ['/css/styles.css'])

# Invalidate all (expensive! avoid in production)
invalidate_paths('E1234567890', ['/*'])

# Better: Use versioned URLs
# /js/app.js â†’ /js/app.v2.3.1.js (no invalidation needed)
```

---

## Edge Computing

### Lambda@Edge vs CloudFront Functions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Edge Compute Comparison                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Feature          â”‚ CloudFront Functions â”‚ Lambda@Edge                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   Runtime          â”‚ JavaScript only      â”‚ Node.js, Python            â”‚
â”‚   Execution Time   â”‚ < 1 ms               â”‚ < 5 sec (viewer)           â”‚
â”‚                    â”‚                      â”‚ < 30 sec (origin)          â”‚
â”‚   Memory           â”‚ 2 MB                 â”‚ 128 MB - 10 GB             â”‚
â”‚   Network Access   â”‚ No                   â”‚ Yes                        â”‚
â”‚   File System      â”‚ No                   â”‚ Read-only /tmp             â”‚
â”‚   Request Body     â”‚ No                   â”‚ Yes (origin events)        â”‚
â”‚   Pricing          â”‚ $0.10 per million    â”‚ $0.60 per million +        â”‚
â”‚                    â”‚                      â”‚ duration                   â”‚
â”‚   Deploy Location  â”‚ All edge locations   â”‚ Regional edge caches       â”‚
â”‚   Cold Start       â”‚ None                 â”‚ Possible                   â”‚
â”‚                                                                         â”‚
â”‚   USE CASES:                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  CloudFront Functions:                                          â”‚  â”‚
â”‚   â”‚  â€¢ URL rewrites/redirects                                        â”‚  â”‚
â”‚   â”‚  â€¢ Header manipulation                                           â”‚  â”‚
â”‚   â”‚  â€¢ Cache key normalization                                       â”‚  â”‚
â”‚   â”‚  â€¢ Simple A/B testing                                            â”‚  â”‚
â”‚   â”‚  â€¢ JWT validation (simple)                                       â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚  Lambda@Edge:                                                    â”‚  â”‚
â”‚   â”‚  â€¢ Complex authentication                                        â”‚  â”‚
â”‚   â”‚  â€¢ Dynamic image resizing                                        â”‚  â”‚
â”‚   â”‚  â€¢ Server-side rendering                                         â”‚  â”‚
â”‚   â”‚  â€¢ Personalization                                               â”‚  â”‚
â”‚   â”‚  â€¢ Bot detection/mitigation                                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CloudFront Function Example

```javascript
// URL Rewrite: Add index.html for directory requests
function handler(event) {
    var request = event.request;
    var uri = request.uri;
    
    // Check if URI is missing a file extension
    if (uri.endsWith('/')) {
        request.uri += 'index.html';
    } else if (!uri.includes('.')) {
        request.uri += '/index.html';
    }
    
    return request;
}

// A/B Testing: Route 20% of traffic to new version
function handler(event) {
    var request = event.request;
    
    // Check for existing cookie
    var cookies = request.cookies;
    var experimentGroup = cookies['experiment-group'] 
        ? cookies['experiment-group'].value 
        : null;
    
    // Assign to group if not already assigned
    if (!experimentGroup) {
        experimentGroup = Math.random() < 0.2 ? 'B' : 'A';
    }
    
    // Route to appropriate origin path
    if (experimentGroup === 'B') {
        request.uri = '/v2' + request.uri;
    }
    
    // Set cookie for consistency
    request.cookies['experiment-group'] = { value: experimentGroup };
    
    return request;
}

// Security Headers
function handler(event) {
    var response = event.response;
    var headers = response.headers;
    
    // Add security headers
    headers['strict-transport-security'] = { 
        value: 'max-age=31536000; includeSubdomains; preload' 
    };
    headers['x-content-type-options'] = { value: 'nosniff' };
    headers['x-frame-options'] = { value: 'DENY' };
    headers['x-xss-protection'] = { value: '1; mode=block' };
    headers['content-security-policy'] = { 
        value: "default-src 'self'; script-src 'self' 'unsafe-inline'" 
    };
    
    return response;
}
```

### Lambda@Edge Example

```python
# Dynamic Image Resizing at Edge
import boto3
from PIL import Image
import io
import base64

def lambda_handler(event, context):
    request = event['Records'][0]['cf']['request']
    
    # Parse query parameters
    params = request.get('querystring', '')
    width = None
    height = None
    
    for param in params.split('&'):
        if param.startswith('w='):
            width = int(param[2:])
        elif param.startswith('h='):
            height = int(param[2:])
    
    # If no resize requested, pass through
    if not width and not height:
        return request
    
    # Fetch original image from S3
    s3 = boto3.client('s3')
    bucket = 'my-images-bucket'
    key = request['uri'].lstrip('/')
    
    try:
        response = s3.get_object(Bucket=bucket, Key=key)
        image_data = response['Body'].read()
        
        # Resize image
        img = Image.open(io.BytesIO(image_data))
        if width and height:
            img = img.resize((width, height), Image.LANCZOS)
        elif width:
            ratio = width / img.width
            img = img.resize((width, int(img.height * ratio)), Image.LANCZOS)
        elif height:
            ratio = height / img.height
            img = img.resize((int(img.width * ratio), height), Image.LANCZOS)
        
        # Convert to bytes
        buffer = io.BytesIO()
        img.save(buffer, format='WEBP', quality=85)
        buffer.seek(0)
        
        # Return resized image
        return {
            'status': '200',
            'statusDescription': 'OK',
            'headers': {
                'content-type': [{'value': 'image/webp'}],
                'cache-control': [{'value': 'public, max-age=31536000'}]
            },
            'body': base64.b64encode(buffer.read()).decode('utf-8'),
            'bodyEncoding': 'base64'
        }
        
    except Exception as e:
        print(f"Error: {e}")
        return request  # Fall back to origin
```

---

## Global Accelerator

For non-HTTP workloads or when you need static IPs.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Global Accelerator Architecture                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   CloudFront vs Global Accelerator:                                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â”‚
â”‚                                                                         â”‚
â”‚   CloudFront:                                                           â”‚
â”‚   â€¢ HTTP/HTTPS only                                                     â”‚
â”‚   â€¢ Content caching                                                     â”‚
â”‚   â€¢ Edge processing (Lambda@Edge)                                       â”‚
â”‚   â€¢ Dynamic content acceleration                                        â”‚
â”‚                                                                         â”‚
â”‚   Global Accelerator:                                                   â”‚
â”‚   â€¢ TCP/UDP traffic                                                     â”‚
â”‚   â€¢ No caching (proxy only)                                             â”‚
â”‚   â€¢ Static anycast IPs                                                  â”‚
â”‚   â€¢ Health-based failover                                               â”‚
â”‚   â€¢ Gaming, IoT, VoIP                                                   â”‚
â”‚                                                                         â”‚
â”‚   Architecture:                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚   Users                                                          â”‚  â”‚
â”‚   â”‚     â”‚                                                            â”‚  â”‚
â”‚   â”‚     â”‚  Static Anycast IPs: 1.2.3.4, 5.6.7.8                     â”‚  â”‚
â”‚   â”‚     â–¼                                                            â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚   â”‚   â”‚              AWS Global Network                         â”‚    â”‚  â”‚
â”‚   â”‚   â”‚         (Edge to origin over AWS backbone)              â”‚    â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚   â”‚                     â”‚                                            â”‚  â”‚
â”‚   â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚  â”‚
â”‚   â”‚     â–¼               â–¼               â–¼                           â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚
â”‚   â”‚   â”‚Endpoint â”‚   â”‚Endpoint â”‚   â”‚Endpoint â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚Group 1  â”‚   â”‚Group 2  â”‚   â”‚Group 3  â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚us-east-1â”‚   â”‚eu-west-1â”‚   â”‚ap-north â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚         â”‚   â”‚         â”‚   â”‚         â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚EC2, ALB â”‚   â”‚EC2, ALB â”‚   â”‚EC2, ALB â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚NLB, EIP â”‚   â”‚NLB, EIP â”‚   â”‚NLB, EIP â”‚                      â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   USE CASES:                                                            â”‚
â”‚   â€¢ Gaming: Low-latency UDP                                             â”‚
â”‚   â€¢ VoIP: Real-time audio/video                                         â”‚
â”‚   â€¢ IoT: MQTT over TCP                                                  â”‚
â”‚   â€¢ Static IP requirements                                              â”‚
â”‚   â€¢ Multi-region failover                                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Edge Security

### WAF Integration

```hcl
# WAFv2 Web ACL for CloudFront
resource "aws_wafv2_web_acl" "cloudfront" {
  name        = "cloudfront-waf"
  scope       = "CLOUDFRONT"  # Must be CLOUDFRONT for CloudFront
  provider    = aws.us_east_1  # WAF for CloudFront must be in us-east-1
  
  default_action {
    allow {}
  }
  
  # AWS Managed Rules - Common threats
  rule {
    name     = "AWSManagedRulesCommonRuleSet"
    priority = 1
    
    override_action { none {} }
    
    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesCommonRuleSet"
        vendor_name = "AWS"
      }
    }
    
    visibility_config {
      sampled_requests_enabled   = true
      cloudwatch_metrics_enabled = true
      metric_name                = "CommonRuleSet"
    }
  }
  
  # Rate limiting
  rule {
    name     = "RateLimitRule"
    priority = 2
    
    action { block {} }
    
    statement {
      rate_based_statement {
        limit              = 2000  # requests per 5 minutes per IP
        aggregate_key_type = "IP"
      }
    }
    
    visibility_config {
      sampled_requests_enabled   = true
      cloudwatch_metrics_enabled = true
      metric_name                = "RateLimitRule"
    }
  }
  
  # Geo blocking (optional)
  rule {
    name     = "GeoBlockRule"
    priority = 3
    
    action { block {} }
    
    statement {
      geo_match_statement {
        country_codes = ["RU", "CN", "KP"]
      }
    }
    
    visibility_config {
      sampled_requests_enabled   = true
      cloudwatch_metrics_enabled = true
      metric_name                = "GeoBlockRule"
    }
  }
  
  visibility_config {
    sampled_requests_enabled   = true
    cloudwatch_metrics_enabled = true
    metric_name                = "CloudFrontWAF"
  }
}
```

---

## ğŸ¯ Interview Questions

<AccordionGroup>
  <Accordion title="Q1: How do you optimize CloudFront cache hit ratio?">
    **Strategies:**
    
    1. **Normalize cache key**:
       - Remove unnecessary query strings
       - Normalize header values
       - Don't include cookies for static content
    
    2. **Use versioned URLs**:
       - `/js/app.v2.3.1.js` instead of `/js/app.js?v=2.3.1`
       - Allows long TTL without invalidation
    
    3. **Configure appropriate TTLs**:
       - Static assets: 1 year
       - HTML: 1 hour to 1 day
       - API: 0 or short TTL
    
    4. **Use Origin Shield**:
       - Additional caching layer
       - Reduces origin requests
    
    5. **Monitor metrics**:
       - Cache hit ratio in CloudWatch
       - Analyze popular request reports
  </Accordion>
  
  <Accordion title="Q2: When would you use Global Accelerator over CloudFront?">
    **Use Global Accelerator when:**
    - TCP/UDP traffic (not HTTP)
    - Gaming, IoT, VoIP applications
    - Need static anycast IPs
    - Need instant failover between regions
    - No caching needed
    
    **Use CloudFront when:**
    - HTTP/HTTPS traffic
    - Need content caching
    - Edge compute (Lambda@Edge)
    - Static website hosting
    
    **Use both together:**
    - CloudFront for web traffic
    - Global Accelerator for WebSocket/gaming
  </Accordion>
  
  <Accordion title="Q3: How do you secure content on CloudFront?">
    **Security layers:**
    
    1. **HTTPS only**: Redirect HTTP to HTTPS
    
    2. **Origin Access Control**: S3 only accessible via CloudFront
    
    3. **Signed URLs/Cookies**: Restrict access to authenticated users
    
    4. **WAF**: Block common attacks, rate limiting
    
    5. **Shield**: DDoS protection (Standard free, Advanced paid)
    
    6. **Field-Level Encryption**: Encrypt sensitive form data
    
    7. **Geo-restrictions**: Block/allow by country
  </Accordion>
  
  <Accordion title="Q4: CloudFront Functions vs Lambda@Edge - when to use each?">
    **CloudFront Functions:**
    - Simple, sub-millisecond operations
    - URL rewrites, header manipulation
    - Cost-effective at high scale
    - No network access needed
    
    **Lambda@Edge:**
    - Complex logic, >1ms execution
    - Need to access external services
    - Image processing, personalization
    - Request body access needed
    
    **Cost example at 1B requests/month:**
    - CloudFront Functions: ~$100
    - Lambda@Edge: ~$600+
  </Accordion>
  
  <Accordion title="Q5: How do you handle cache invalidation at scale?">
    **Best practices:**
    
    1. **Avoid invalidation**: Use versioned URLs
       ```
       /js/app.abc123.js (content hash in filename)
       ```
    
    2. **Invalidate smartly**:
       - Specific paths, not wildcards
       - Batch invalidations
       - First 1000/month free
    
    3. **Short TTL for dynamic content**:
       - Let cache expire naturally
       - Use Cache-Control headers
    
    4. **Origin Shield**:
       - Single point to invalidate
       - Reduces invalidation spread time
  </Accordion>
</AccordionGroup>

---

## ğŸ§ª Hands-On Lab: Deploy Static Site with CloudFront

<Steps>
  <Step title="Create S3 Bucket">
    Private bucket with static website files
  </Step>
  
  <Step title="Create CloudFront Distribution">
    S3 origin with Origin Access Control
  </Step>
  
  <Step title="Configure Custom Domain">
    ACM certificate in us-east-1, Route 53 alias
  </Step>
  
  <Step title="Add CloudFront Function">
    URL rewrite for SPA routing
  </Step>
  
  <Step title="Enable WAF">
    AWS managed rules + rate limiting
  </Step>
  
  <Step title="Monitor Performance">
    CloudWatch metrics, cache hit ratio
  </Step>
</Steps>

---

## Next Module

<Card title="Messaging & Integration" icon="arrows-split-up-and-left" href="/aws/messaging">
  Master SQS, SNS, EventBridge, and event-driven architectures
</Card>
